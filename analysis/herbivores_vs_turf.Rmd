---
title: "herbivores_vs_turf"
author: "CEB"
date: '2025-03-19'
output: html_document
---

#load packages
```{r}
library(tidyverse)

#for bayesian analysis:
library(brms)
library(tidybayes)

#for plotting:
library(cowplot)

library(jtools)

```


###set plot theme
```{r}
theme_casey<-
  theme_bw()+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        text = element_text(size = 14, family = "Arial"),
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA)
        )

theme_set(theme_casey) 
  
```


#load data:
```{r}
trans_site_all_dat<-read.csv("../data/seychelles_uvc_dat.csv")%>%
  select(-X)
trans_site_all_dat

```


#hypothesis H5: effect of turf pp on herbivore productivity
```{r}

#adjustment set to use turf cover, exposure, structure, turf n15 is consistent throughout, so use this one

#add column for centered, log data:----
trans_site_all_dat_c<-
  trans_site_all_dat%>%
  mutate(turf_n15_c = base::scale(mean_turf_n15, center = TRUE, scale = FALSE),
         turf_prop_c = base::scale(turf, center = TRUE, scale = FALSE),
         turf_productivity_c = base::scale(mean_turf_prod_mm_day, center = TRUE, scale = FALSE),
         log_herb_bio = log(herb_biomass_kg_ha),
         log_herb_prod = log(herb_productivity_kg_ha_day),
         log_turf_cover = log(turf),
         structure_c = base::scale(structure, center = TRUE, scale = FALSE),
         exposure_c = base::scale(Exposure_J_m3, center = TRUE, scale = FALSE),
         turf_height_c =  base::scale(mean_turf_height, center = TRUE, scale = FALSE),
         log_herb_bio_c = base::scale(log_herb_bio, center = TRUE, scale = FALSE),
         log_herb_prod_c = base::scale(log_herb_prod, center = TRUE, scale = FALSE),
         pred_bio_c = base::scale(pred_biomass_kg_ha, center = TRUE, scale = FALSE),
         log_pred_bio = log(pred_biomass_kg_ha + 1),
         log_pred_bio_c = base::scale(log_pred_bio, center = TRUE, scale = FALSE))
trans_site_all_dat_c


##run model ---
#also checked non-log model in previous versions, and everything looks similar to logged, proceed with log because makes more sense for the response (all positive) and allows comparison of effect sizes with biomass (which definitely needs to be logged because of wide range of values). 
herb_prod_turf_pp_brms<-
  brm(
 log_herb_prod~turf_productivity_c + turf_prop_c + turf_n15_c + structure_c  + exposure_c + (1|Island), 
  data = trans_site_all_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/herb_prod_turf_pp_brms")
print(herb_prod_turf_pp_brms) #worked 

pp_check(herb_prod_turf_pp_brms) #looks okay 
plot(herb_prod_turf_pp_brms, ask = FALSE) #looks good

hypothesis(herb_prod_turf_pp_brms, "turf_productivity_c>0") 
#(turf_productivit... > 0	      4.22	    16.4	  -19.03    	25.46	    2.31    	0.7	
#positive effect, but wide error so 0.7 PP

##extract effects-----
herb_prod_turf_pp_brms %>%
  spread_draws(b_turf_productivity_c) %>%
  median_hdci(b_turf_productivity_c/10)
#0.4445617	-3.235387	3.358798	

#because Y is log-transformed: an increase of one unit in X is associated with a change in the median of Y by a factor of exp(B)
#but estimates are crazy because increase in turf growth by 1 mm/day is super high, so divide by 10 to make it .1 mm/day increase:

herb_prod_turf_pp_brms %>%
  spread_draws(b_turf_productivity_c) %>%
  median_hdi(exp(b_turf_productivity_c/10))
#1.559806	2.026816e-06	12.76673	0.95	  0.95	median	hdi

#so each .1 mm/day increase in turf growth rate, herbivore productivity increases by a factor of 1.55 
#Previous result was 1.55 at 0.81 PP, so similar effect size but wider errors here (so lower PP)


```



##Hypothesis H7 - test for effect of turf cover on herbivore productivity
```{r}
#adjustment set is the same as above, so extract effects from that model: 

hypothesis(herb_prod_turf_pp_brms, "turf_prop_c>0") 
#-0.94	1.33	-3.12	1.22	0.29	0.22	
#if anything, evidence for NEGATIVE effect if turf cover on herbivore growth....


herb_prod_turf_pp_brms %>%
  spread_draws(b_turf_prop_c) %>%
  median_hdi(b_turf_prop_c/10)

#because Y is log-transformed: an increase of one unit in X is associated with a change in the median of Y by a factor of exp(B)
#but estimates are crazy because increase in proportional turf by 1 unit is super high, so divide to make it .1 proportional increase (so 10% increase):
herb_prod_turf_pp_brms %>%
  spread_draws(b_turf_prop_c) %>%
  median_hdi(exp(b_turf_prop_c/10))
#0.9103908	0.67905	1.161185		0.95	median	hdi

#so each 10% increase in turf cover results in decrease in herbivore biomass by a factor of 0.91. Or:
1-0.9103908 #0.0896092: 8.96% decrease
1-0.67905 #0.32095: 32.10% decrease
1.161185-1 #0.161185: 16.12% increase
#very similar estimates as original model*

```


#Hypothesis H6 - effects of turf pp on herbivore bimass:
```{r}
##same models as above for herbivore productivity: 

##run model---
herb_bio_turf_pp_brms<-
  brm(
 log_herb_bio~turf_productivity_c + turf_prop_c + turf_n15_c + structure_c  + exposure_c + (1|Island), 
  data = trans_site_all_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/herb_bio_turf_pp_brms") 
print(herb_bio_turf_pp_brms) #worked 

pp_check(herb_bio_turf_pp_brms) #looks good
plot(herb_bio_turf_pp_brms, ask = FALSE) #looks good

hypothesis(herb_bio_turf_pp_brms, "turf_productivity_c>0") 
#5.97	21.44	-25.87	36.88	2.08	0.68
#positive effect, but fairly low PP because wide errors


##extract effects-----
herb_bio_turf_pp_brms %>%
  spread_draws(b_turf_productivity_c) %>%
  median_hdi(b_turf_productivity_c/10)
#0.6157091	-3.859791	4.803158	

#because Y is log-transformed: an increase of one unit in X is associated with a change in the median of Y by a factor of exp(B)
#but estimates are crazy because increase in turf growth by 1 mm/day is super high, so divide by 10 to make it .1 mm/day increase:
herb_bio_turf_pp_brms %>%
  spread_draws(b_turf_productivity_c) %>%
  median_hdi(exp(b_turf_productivity_c/10))
#1.850969	6.252103e-11	40.01519				0.95	  0.95	median	hdi

#so each .1 mm/day increase in turf growth rate, herbivore productivity increases by a factor of 1.85. 
#Previous result was 1.95 at 0.76 PP, so slightly lower effect size and wider errors here (so lower PP)

```

##Hypothesis H8 - test for effect of turf cover on herbivore biomass
```{r}

#adjustment set is the same as above, so extract effects from that model: 

hypothesis(herb_bio_turf_pp_brms, "turf_prop_c>0") 
#-0.77	1.34	-2.93	1.44	0.37	0.27		
#if anything, evidence for NEGATIVE effect

herb_bio_turf_pp_brms %>%
  spread_draws(b_turf_prop_c) %>%
  median_hdi(b_turf_prop_c/10)

herb_bio_turf_pp_brms %>%
  spread_draws(b_turf_prop_c) %>%
  median_hdi(exp(b_turf_prop_c/10))
#0.924464	0.6896171	1.181382			0.95	median	hdi

#because Y is log-transformed: an increase of one unit in X is associated with a change in the median of Y by a factor of exp(B)
#but estimates are crazy because increase in proportional turf by 1 unit is super high, so divide to make it .1 proportional increase (so 10% increase):
#so each 10% increase in turf cover results in decrease in herbivore biomass by a factor of 0.92.
#very similar estimates as original model*


```


##Hypothesis H9 - Effect of n15 on herbivore productivity
```{r}
#direct = 	turf cover, exposure, turf growth, structure
#total = 		exposure


###direct effect----
#same as above models!:
print(herb_prod_turf_pp_brms)

hypothesis(herb_prod_turf_pp_brms, "turf_n15_c>0") 
#-0.17	0.82	-1.33	1.06	0.64	0.39		
#yup, not much evidence for direct effect, and if anything it's negative


herb_prod_turf_pp_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(b_turf_n15_c)


#because Y is log-transformed: an increase of one unit in X is associated with a change in the median of Y by a factor of exp(B)
herb_prod_turf_pp_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(exp(b_turf_n15_c))
#0.8412954	0.0005352696	2.896202	


###total effect-----
herb_prod_n15_total_brms<-
  brm(
 log_herb_prod~  + turf_n15_c   + exposure_c + (1|Island), 
  data = trans_site_all_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/herb_prod_n15_total_brms") #
print(herb_prod_n15_total_brms) #worked 

pp_check(herb_prod_n15_total_brms) #looks good
plot(herb_prod_n15_total_brms, ask = FALSE) #looks good

hypothesis(herb_prod_n15_total_brms, "turf_n15_c>0") 
#0.18	0.32	-0.35	0.66	2.98	0.75
#some evidence for positive total effect


##extract effects-----
herb_prod_n15_total_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(b_turf_n15_c)

#because Y is log-transformed: an increase of one unit in X is associated with a change in the median of Y by a factor of exp(B)
herb_prod_n15_total_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(exp(b_turf_n15_c))
#1.210853	0.5287744	2.032827				0.95	  0.95	median	hdi

#so each 1 unit increase in turf n15, herbivore productivity increases by a factor of 1.21. 
#Previous result was 1.14 at 0.72 PP, so quite similar but actually slightly stronger effect here. 


```


##Hypothesis H10 - effect of n15 on herbivore biomass
```{r}
#same adjustment sets needed as for herbivore productivity:

###direct effect----
#same as above models!:
print(herb_bio_turf_pp_brms)

hypothesis(herb_bio_turf_pp_brms, "turf_n15_c>0") 
#0.09	0.99	-1.4	1.65	1.17	0.54	
#yup, really no evidence for direct effect


herb_bio_turf_pp_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(b_turf_n15_c)

#because Y is log-transformed: an increase of one unit in X is associated with a change in the median of Y by a factor of exp(B)
herb_bio_turf_pp_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(exp(b_turf_n15_c))
#1.081328	0.001896154	5.216385	



###total effect-----
herb_bio_n15_total_brms<-
  brm(
 log_herb_bio~  + turf_n15_c   + exposure_c + (1|Island), 
  data = trans_site_all_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/herb_bio_n15_total_brms") 
print(herb_bio_n15_total_brms) #worked 

pp_check(herb_bio_n15_total_brms) #looks good
plot(herb_bio_n15_total_brms, ask = FALSE) #looks good

hypothesis(herb_bio_n15_total_brms, "turf_n15_c>0") 
#0.44	0.39	-0.2	1.06	7.7	0.89			
#so pretty strong evidence for positive effect. 


##extract effects-----
herb_bio_n15_total_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(b_turf_n15_c)

#because Y is log-transformed: an increase of one unit in X is associated with a change in the median of Y by a factor of exp(B)
herb_bio_n15_total_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(exp(b_turf_n15_c))
#1.557848	0.5732776	3.013945					0.95	  0.95	median	hdi

#so each 1 unit increase in turf n15, herbivore biomass increases by a factor of 1.56 
#Previous result was 1.53 (PP = 0.91) so quite similar. 

```


###Plot results--------
#plots for turf productivity vs. herbivore productivity
```{r}
#plot partialized residuals-----
me_herb_prod_pp<-conditional_effects(herb_prod_turf_pp_brms, prob = .75, effects = 'turf_productivity_c', plot = FALSE)[[1]]

#extract partialized residuals
p_herb_prod_pp<-partialize(herb_prod_turf_pp_brms, vars= "turf_productivity_c",  data = trans_site_all_dat_c)


#back-transform growth, centered/scaled n15:----
#get data for un-scaling and centering:
mean(trans_site_all_dat_c$mean_turf_prod_mm_day, na.rm=TRUE) #0.3158526

me_herb_prod_pp_unscale<-
  me_herb_prod_pp%>%
  mutate(mean_turf_prod_mm_day = turf_productivity_c + 0.3158526 ) # + mean


herb_prod_pp_part_plot<-
p_herb_prod_pp %>%
  ggplot(aes(x = mean_turf_prod_mm_day, y = log_herb_prod)) +
     geom_point(color = "#EE7733", fill = "#EE7733",  alpha = 0.4, size = 3) + #, size = .8, width=.07,
    geom_ribbon(data = me_herb_prod_pp_unscale, aes(ymin =(lower__), ymax=(upper__)), alpha = .2, fill = "#EE7733")+
    geom_line(data = me_herb_prod_pp_unscale, aes(y = (estimate__)), lwd = 1.2, colour = "#EE7733") + 
  ylab(bquote(Herbivore~productivity~(kg~ha^-1~day^-1)))+
  xlab(bquote(Turf~productivity~(mm~day^-1)))+
    #  scale_y_continuous(labels = c(0.1, 0.5,  1, 5), breaks = c(log(0.1), log (0.5), log(1), log(5)), limits = c(-3, log(6)))+ 
        scale_y_continuous(labels = c(0.1,  1), breaks = c(log(0.1),  log(1) ), limits = c(-3, log(2)))+ 
  theme_bw()+
    guides(size = "none", colour = "none",  fill = guide_legend(title="Confidence level")) + 
    theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
    #            text = element_text(size = 24),
        legend.position='none')
herb_prod_pp_part_plot




#posterior prediction plots------
herb_prod_pp_post_plot<-
herb_prod_turf_pp_brms %>%
  spread_draws(b_turf_productivity_c) %>%
  ggplot(aes(y = 0, x = b_turf_productivity_c/10, fill = "#EE7733")) + #rescale so .1 mm/day
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 2, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#EE7733"),0.3))+
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
  scale_x_continuous(limits=c(-5, 5), breaks=seq(-5, 5,5))+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
       # text=element_text(size=16,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_prod_pp_post_plot


##combine and save---------
##make inset plots, then combine and save:
herb.prod.pp.plot.with.inset <-
  ggdraw() +
  draw_plot(herb_prod_pp_part_plot) +
  draw_plot(herb_prod_pp_post_plot, x = 0.6, y = .07, width = .35, height = .35)
herb.prod.pp.plot.with.inset

#Save the plot with ggsave()
#ggsave(filename = "../outputs/figures/figure4a_herbivore_productivity_vs_turf_productivity.png", 
#       plot = herb.prod.pp.plot.with.inset,     width = 11,      height = 7.5,      units = "cm",      dpi = 300)


```

#plots for turf productivity vs. herbivore biomass
```{r}
#plot partialized residuals-----
me_herb_bio_pp<-conditional_effects(herb_bio_turf_pp_brms, prob = .75, effects = 'turf_productivity_c', plot = FALSE)[[1]]

#extract partialized residuals
p_herb_bio_pp<-partialize(herb_bio_turf_pp_brms, vars= "turf_productivity_c",  data = trans_site_all_dat_c)


#back-transform growth, centered/scaled n15:----
#get data for un-scaling and centering:
mean(trans_site_all_dat_c$mean_turf_prod_mm_day, na.rm=TRUE) #0.3158526

me_herb_bio_pp_unscale<-
  me_herb_bio_pp%>%
  mutate(mean_turf_prod_mm_day = turf_productivity_c + 0.3158526 ) # + mean


herb_bio_pp_part_plot<-
p_herb_bio_pp %>%
  ggplot(aes(x = mean_turf_prod_mm_day, y = log_herb_bio)) +
     geom_point(color = "#0072B2", fill = "#0072B2",  alpha = 0.4, size = 3) + #, size = .8, width=.07,
    geom_ribbon(data = me_herb_bio_pp_unscale, aes(ymin =(lower__), ymax=(upper__)), alpha = .2, fill = "#0072B2")+
    geom_line(data = me_herb_bio_pp_unscale, aes(y = (estimate__)), lwd = 1.2, colour = "#0072B2") +
  ylab(bquote(Herbivore~biomass~(kg~ha^-1)))+
  xlab(bquote(Turf~productivity~(mm~day^-1)))+
     #scale_y_continuous(labels = c(10, 100, 1000, 10000), breaks = c(log(10), log(100), log(1000), log(10000)), limits = c(log(10), log(10000)))+ 
       scale_y_continuous(labels = c(10, 100, 1000), breaks = c(log(10), log(100), log(1000)), limits = c(log(10), log(5000)))+ 
  theme_bw()+
    guides(size = "none", colour = "none",  fill = guide_legend(title="Confidence level")) + 
    theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
    #            text = element_text(size = 24),
        legend.position='none')
herb_bio_pp_part_plot




#posterior prediction plots------
herb_bio_pp_post_plot<-
herb_bio_turf_pp_brms %>%
  spread_draws(b_turf_productivity_c) %>%
  ggplot(aes(y = 0, x = b_turf_productivity_c/10, fill = "#0072B2")) + #rescale so .1 mm/day
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 2, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#0072B2"),0.3))+
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
  scale_x_continuous(limits=c(-10, 10), breaks=seq(-10, 10,5))+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
       # text=element_text(size=16,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_bio_pp_post_plot


##combine and save---------
##make inset plots, then combine and save:
herb.bio.pp.plot.with.inset <-
  ggdraw() +
  draw_plot(herb_bio_pp_part_plot) +
  draw_plot(herb_bio_pp_post_plot, x = 0.6, y = .07, width = .35, height = .35)
herb.bio.pp.plot.with.inset

#Save the plot with ggsave()
#ggsave(filename = "../outputs/figures/figure4b_herbivore_biomass_vs_turf_productivity.png", 
#      plot = herb.bio.pp.plot.with.inset,     width = 11,      height = 7.5,      units = "cm",      dpi = 300)


```

#plots for turf cover vs. herbivore productivity
```{r}
#plot partialized residuals-----
me_herb_prod_cover<-conditional_effects(herb_prod_turf_pp_brms, prob = .75, effects = 'turf_prop_c', plot = FALSE)[[1]]

#extract partialized residuals
p_herb_prod_cover<-partialize(herb_prod_turf_pp_brms, vars= "turf_prop_c",  data = trans_site_all_dat_c)


#back-transform growth, centered/scaled n15:----
#get data for un-scaling and centering:
mean(trans_site_all_dat_c$turf, na.rm=TRUE) #0.135

me_herb_prod_cover_unscale<-
  me_herb_prod_cover%>%
  mutate(turf = turf_prop_c + 0.135 ) # + mean


herb_prod_cover_part_plot<-
p_herb_prod_cover %>%
  ggplot(aes(x = turf, y = log_herb_prod)) +
     geom_point(color = "#EE7733", fill = "#EE7733",  alpha = 0.4, size = 3) + #, size = .8, width=.07,
    geom_ribbon(data = me_herb_prod_cover_unscale, aes(ymin =(lower__), ymax=(upper__)), alpha = .2, fill = "#EE7733")+
    geom_line(data = me_herb_prod_cover_unscale, aes(y = (estimate__)), lwd = 1.2, colour = "#EE7733") +
  ylab(bquote(Herbivore~productivity~(kg~ha^-1~day^-1)))+
        scale_y_continuous(labels = c(0.1, 1, 10), breaks = c(log(0.1), log(1),  log(10)), limits = c(log(0.1), log(2)))+ 
xlab("Turf (proportional cover)")+
  theme_bw()+
    guides(size = "none", colour = "none",  fill = guide_legend(title="Confidence level")) + 
    theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
    #            text = element_text(size = 24),
        legend.position='none')
herb_prod_cover_part_plot




#posterior prediction plots------
herb_prod_cover_post_plot<-
herb_prod_turf_pp_brms %>%
  spread_draws(b_turf_prop_c) %>%
  ggplot(aes(y = 0, x = b_turf_prop_c, fill = "#EE7733")) +
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 2, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#EE7733"),0.3))+
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
 # scale_x_continuous( breaks=c(0,1,2), labels =c("0.0", "1.0", "2.0"))+
 # scale_x_continuous(breaks=seq(-.5, .5,.5))+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
       # text=element_text(size=16,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_prod_cover_post_plot


##combine and save---------
##make inset plots, then combine and save:
herb.prod.cover.plot.with.inset <-
  ggdraw() +
  draw_plot(herb_prod_cover_part_plot) +
  draw_plot(herb_prod_cover_post_plot, x = 0.6, y = .64, width = .35, height = .35)
herb.prod.cover.plot.with.inset

#Save the plot with ggsave()
#ggsave(filename = "../outputs/figures/figure4c_herbivore_productivity_vs_turf_cover.png", 
#       plot = herb.prod.cover.plot.with.inset,
#       width = 11,
#       height = 7.5,
#       units = "cm",
#       dpi = 300)


```



#plots for turf cover vs. herbivore biomass
```{r}
#plot partialized residuals-----
me_herb_bio_cover<-conditional_effects(herb_bio_turf_pp_brms, prob = .75, effects = 'turf_prop_c', plot = FALSE)[[1]]

#extract partialized residuals
p_herb_bio_cover<-partialize(herb_bio_turf_pp_brms, vars= "turf_prop_c",  data = trans_site_all_dat_c)


#back-transform growth, centered/scaled n15:----
#get data for un-scaling and centering:
mean(trans_site_all_dat_c$turf, na.rm=TRUE) #0.135

me_herb_bio_cover_unscale<-
  me_herb_bio_cover%>%
  mutate(turf = turf_prop_c + 0.135 ) # + mean


herb_bio_cover_part_plot<-
p_herb_bio_cover %>%
  ggplot(aes(x = turf, y = log_herb_bio)) +
     geom_point(color = "#0072B2", fill = "#0072B2",  alpha = 0.4, size = 3) + #, size = .8, width=.07,
    geom_ribbon(data = me_herb_bio_cover_unscale, aes(ymin =(lower__), ymax=(upper__)), alpha = .2, fill = "#0072B2")+
    geom_line(data = me_herb_bio_cover_unscale, aes(y = (estimate__)), lwd = 1.2, colour = "#0072B2") +
  ylab(bquote(Herbivore~biomass~(kg~ha^-1)))+
     #  scale_y_continuous(labels = c(10, 100, 1000, 10000), breaks = c(log(10), log(100), log(1000), log(10000)), limits = c(log(50), log(2000)))+ 
   scale_y_continuous(labels = c(10, 100, 1000), breaks = c(log(10), log(100), log(1000)), limits = c(log(10), log(5000)))+ 
xlab("Turf (proportional cover)")+
  theme_bw()+
    guides(size = "none", colour = "none",  fill = guide_legend(title="Confidence level")) + 
    theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
    #            text = element_text(size = 24),
        legend.position='none')
herb_bio_cover_part_plot




#posterior prediction plots------
herb_bio_cover_post_plot<-
herb_bio_turf_pp_brms %>%
  spread_draws(b_turf_prop_c) %>%
  ggplot(aes(y = 0, x = b_turf_prop_c, fill = "#0072B2")) +
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 2, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#0072B2"),0.3))+
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
 # scale_x_continuous( breaks=c(0,1,2), labels =c("0.0", "1.0", "2.0"))+
  scale_x_continuous(breaks=seq(-5, 5,5))+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
       # text=element_text(size=16,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_bio_cover_post_plot


##combine and save---------
##make inset plots, then combine and save:
herb.bio.cover.plot.with.inset <-
  ggdraw() +
  draw_plot(herb_bio_cover_part_plot) +
  draw_plot(herb_bio_cover_post_plot, x = 0.6, y = .07, width = .35, height = .35)
herb.bio.cover.plot.with.inset


# Can save the plot with ggsave()
#ggsave(filename = "../outputs/figures/figure4d_herbivore_biomass_vs_turf_cover.png", 
#       plot = herb.bio.cover.plot.with.inset,
#       width = 11,
#       height = 7.5,
#       units = "cm",
#       dpi = 300)


```



##combine and save all 4 panels of figure 4:
```{r}
herb.bio.pp.plot.with.inset
herb.prod.pp.plot.with.inset
herb.bio.cover.plot.with.inset
herb.prod.cover.plot.with.inset


##actually, works better with patchwork to allow white space between rows:----
library(patchwork)
fig4<-herb.prod.pp.plot.with.inset   + herb.bio.pp.plot.with.inset + plot_spacer() +   plot_spacer() + herb.prod.cover.plot.with.inset  + herb.bio.cover.plot.with.inset + plot_layout(ncol = 2) + 
   plot_layout(heights = c(1, .05, 1)) & theme(plot.background = element_rect(fill = "white",color = "white"), rect = element_rect(fill = "white",color = "white")) #png saving adds weird borders to plots, but re-setting overall theme to white here solves it
fig4

ggsave(filename = "../outputs/figures/figure4_combined.png", 
       plot = fig4,
       width = 25, 
       height = 22,
       units = "cm",
       dpi = 300)



ggsave(filename = "../outputs/figures/figure4_combined.pdf", 
       plot = fig4,
       width = 25, 
       height = 22,
       units = "cm",
       dpi = 300)




```


#plots for turf n15 versus herbivore biomass and productivity
```{r}

##model plots - direct effect of turf nutrients on herb prod-----
#plot partialized residuals-----
me_herb_prod_nutr<-conditional_effects(herb_prod_turf_pp_brms, prob = .75, effects = 'turf_n15_c', plot = FALSE)[[1]]

#extract partialized residuals
p_herb_prod_nutr<-partialize(herb_prod_turf_pp_brms, vars= "turf_n15_c",  data = trans_site_all_dat_c)


#back-transform growth, centered/scaled n15:----
#get data for un-scaling and centering:
mean(trans_site_all_dat_c$mean_turf_n15, na.rm=TRUE) #4.653333

me_herb_prod_nutr_unscale<-
  me_herb_prod_nutr%>%
  mutate(mean_turf_n15 = turf_n15_c + 4.653333 ) # + mean


herb_prod_nutr_part_plot<-
p_herb_prod_nutr %>%
  ggplot(aes(x = mean_turf_n15, y = log_herb_prod)) +
     geom_point(color = "#EE7733", fill = "#EE7733",  alpha = 0.4, size = 3) + #, size = .8, width=.07,
    geom_ribbon(data = me_herb_prod_nutr_unscale, aes(ymin =(lower__), ymax=(upper__)), alpha = .2, fill = "#EE7733")+
    geom_line(data = me_herb_prod_nutr_unscale, aes(y = (estimate__)), lwd = 1.2, colour = "#EE7733") +
  ylab(bquote(Herbivore~productivity~(kg~ha^-1~day^-1)))+
          #scale_y_continuous(labels = c(0.1, 0.25, 0.5, 1), breaks = c(log(0.1), log(0.25), log(0.5), log(1)), limits = c(log(0.08), log(2)))+ 
         scale_y_continuous(labels = c(0.1, 0.25, 0.5, 1), breaks = c(log(0.1), log(0.25), log(0.5), log(1)), limits = c(log(0.08), log(1.5)))+ 
xlab(expression(paste("Turf ", delta^15, "N"))) + 
  theme_bw()+
    guides(size = "none", colour = "none",  fill = guide_legend(title="Confidence level")) + 
    theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
    #            text = element_text(size = 24),
        legend.position='none')
herb_prod_nutr_part_plot




#posterior prediction plots------
herb_prod_nutr_post_plot<-
herb_prod_turf_pp_brms %>%
  spread_draws(b_turf_n15_c) %>%
  ggplot(aes(y = 0, x = b_turf_n15_c, fill = "#EE7733")) + #rescale so .1 mm/day
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 2, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#EE7733"),0.3))+
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
 # scale_x_continuous(limits=c(-2.5, 3), breaks=seq(-2, 3,1))+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
       # text=element_text(size=16,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_prod_nutr_post_plot


##combine and save---------
##make inset plots, then combine and save:
herb.prod.nutr.plot.with.inset <-
  ggdraw() +
  draw_plot(herb_prod_nutr_part_plot) +
  draw_plot(herb_prod_nutr_post_plot, x = 0.6, y = .64, width = .35, height = .35)
herb.prod.nutr.plot.with.inset



##model plots total effect of turf nutrients on herbivore prod-----
#plot partialized residuals-----
me_herb_prod_nutr_total<-conditional_effects(herb_prod_n15_total_brms, prob = .75, effects = 'turf_n15_c', plot = FALSE)[[1]]

#extract partialized residuals
p_herb_prod_nutr_total<-partialize(herb_prod_n15_total_brms, vars= "turf_n15_c",  data = trans_site_all_dat_c)


#back-transform growth, centered/scaled n15:----
#get data for un-scaling and centering:
mean(trans_site_all_dat_c$mean_turf_n15, na.rm=TRUE) #4.653333

me_herb_prod_nutr_total_unscale<-
  me_herb_prod_nutr_total%>%
  mutate(mean_turf_n15 = turf_n15_c + 4.653333 ) # + mean


herb_prod_nutr_part_plot_total<-
p_herb_prod_nutr_total %>%
  ggplot(aes(x = mean_turf_n15, y = log_herb_prod)) +
     geom_point(color = "#EE7733", fill = "#EE7733",  alpha = 0.4, size = 3) + #, size = .8, width=.07,
    geom_ribbon(data = me_herb_prod_nutr_total_unscale, aes(ymin =(lower__), ymax=(upper__)), alpha = .2, fill = "#EE7733")+
    geom_line(data = me_herb_prod_nutr_total_unscale, aes(y = (estimate__)), lwd = 1.2, colour = "#EE7733") +
  ylab(bquote(Herbivore~productivity~(kg~ha^-1~day^-1)))+
    # scale_y_continuous(labels = c(0.1, 0.25, 0.5, 1), breaks = c(log(0.1), log(0.25), log(0.5), log(1)), limits = c(log(0.1), log(2)))+ 
         scale_y_continuous(labels = c(0.1, 0.25, 0.5, 1), breaks = c(log(0.1), log(0.25), log(0.5), log(1)), limits = c(log(0.1), log(1.1)))+ 
xlab(expression(paste("Turf ", delta^15, "N"))) + 
  theme_bw()+
    guides(size = "none", colour = "none",  fill = guide_legend(title="Confidence level")) + 
    theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
    #            text = element_text(size = 24),
        legend.position='none')
herb_prod_nutr_part_plot_total




#posterior prediction plots------
herb_prod_nutr_post_plot_total<-
herb_prod_n15_total_brms %>%
  spread_draws(b_turf_n15_c) %>%
  ggplot(aes(y = 0, x = b_turf_n15_c, fill = "#EE7733")) + #rescale so .1 mm/day
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 2, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#EE7733"),0.3))+
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
 # scale_x_continuous(limits=c(-2.5, 3), breaks=seq(-2, 3,1))+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
       # text=element_text(size=16,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_prod_nutr_post_plot_total


##combine and save---------
##make inset plots, then combine and save:
herb.prod.nutr.plot.with.inset.total <-
  ggdraw() +
  draw_plot(herb_prod_nutr_part_plot_total) +
  draw_plot(herb_prod_nutr_post_plot_total, x = 0.6, y = .06, width = .35, height = .35)
herb.prod.nutr.plot.with.inset.total



##model plots: direct effect of turf n15 on herb bio-----
#plot partialized residuals-----
me_herb_bio_nutr<-conditional_effects(herb_bio_turf_pp_brms, prob = .75, effects = 'turf_n15_c', plot = FALSE)[[1]]

#extract partialized residuals
p_herb_bio_nutr<-partialize(herb_bio_turf_pp_brms, vars= "turf_n15_c",  data = trans_site_all_dat_c)


#back-transform growth, centered/scaled n15:----
#get data for un-scaling and centering:
mean(trans_site_all_dat_c$mean_turf_n15, na.rm=TRUE) #4.653333

me_herb_bio_nutr_unscale<-
  me_herb_bio_nutr%>%
  mutate(mean_turf_n15 = turf_n15_c + 4.653333 ) # + mean


herb_bio_nutr_part_plot<-
p_herb_bio_nutr %>%
  ggplot(aes(x = mean_turf_n15, y = log_herb_bio)) +
     geom_point(color = "#0072B2", fill = "#0072B2",  alpha = 0.4, size = 3) + #, size = .8, width=.07,
    geom_ribbon(data = me_herb_bio_nutr_unscale, aes(ymin =(lower__), ymax=(upper__)), alpha = .2, fill = "#0072B2")+
    geom_line(data = me_herb_bio_nutr_unscale, aes(y = (estimate__)), lwd = 1.2, colour = "#0072B2") +
  ylab(bquote(Herbivore~biomass~(kg~ha^-1)))+
        scale_y_continuous(labels = c(10, 100, 250, 500, 1000, 2000), breaks = c(log(10), log(100), log(250), log(500), log(1000), log(2000)), limits = c(log(50), log(3000)))+ 
           #scale_y_continuous(labels = c(10, 100, 250, 500, 1000, 2000), breaks = c(log(10), log(100), log(250), log(500), log(1000), log(2000)), limits = c(log(100), log(2000)))+ 
xlab(expression(paste("Turf ", delta^15, "N"))) + 
  theme_bw()+
    guides(size = "none", colour = "none",  fill = guide_legend(title="Confidence level")) + 
    theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
    #            text = element_text(size = 24),
        legend.position='none')
herb_bio_nutr_part_plot




#posterior prediction plots------
herb_bio_nutr_post_plot<-
herb_bio_turf_pp_brms %>%
  spread_draws(b_turf_n15_c) %>%
  ggplot(aes(y = 0, x = b_turf_n15_c, fill = "#0072B2")) + #rescale so .1 mm/day
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 2, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#0072B2"),0.3))+
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
  scale_x_continuous(limits=c(-4, 4), breaks=seq(-4, 4,2))+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
       # text=element_text(size=16,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_bio_nutr_post_plot


##combine and save---------
##make inset plots, then combine and save:
herb.bio.nutr.plot.with.inset <-
  ggdraw() +
  draw_plot(herb_bio_nutr_part_plot) +
  draw_plot(herb_bio_nutr_post_plot, x = 0.6, y = .64, width = .35, height = .35)
herb.bio.nutr.plot.with.inset


##model plots - total effect of turf n15 on herb bio-----
#plot partialized residuals-----
me_herb_bio_nutr_total<-conditional_effects(herb_bio_n15_total_brms, prob = .75, effects = 'turf_n15_c', plot = FALSE)[[1]]

#extract partialized residuals
p_herb_bio_nutr_total<-partialize(herb_bio_n15_total_brms, vars= "turf_n15_c",  data = trans_site_all_dat_c)


#back-transform growth, centered/scaled n15:----
#get data for un-scaling and centering:
mean(trans_site_all_dat_c$mean_turf_n15, na.rm=TRUE) #4.653333

me_herb_bio_nutr_total_unscale<-
  me_herb_bio_nutr_total%>%
  mutate(mean_turf_n15 = turf_n15_c + 4.653333 ) # + mean


herb_bio_nutr_part_plot_total<-
p_herb_bio_nutr_total %>%
  ggplot(aes(x = mean_turf_n15, y = log_herb_bio)) +
     geom_point(color = "#0072B2", fill = "#0072B2",  alpha = 0.4, size = 3) + #, size = .8, width=.07,
    geom_ribbon(data = me_herb_bio_nutr_total_unscale, aes(ymin =(lower__), ymax=(upper__)), alpha = .1, fill = "#0072B2")+
    geom_line(data = me_herb_bio_nutr_total_unscale, aes(y = (estimate__)), lwd = 1.2, colour = "#0072B2") +
  ylab(bquote(Herbivore~biomass~(kg~ha^-1)))+
           scale_y_continuous(labels = c(10, 100, 250, 500, 1000, 2000), breaks = c(log(10), log(100), log(250), log(500), log(1000), log(2000)), limits = c(log(100), log(2000)))+ 
     #scale_y_continuous(labels = c(10, 100, 1000), breaks = c(log(10), log(100), log(1000)), limits = c(log(10), log(5000)))+ 
xlab(expression(paste("Turf ", delta^15, "N"))) + 
  theme_bw()+
    guides(size = "none", colour = "none",  fill = guide_legend(title="Confidence level")) + 
    theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
    #            text = element_text(size = 24),
        legend.position='none')
herb_bio_nutr_part_plot_total




#posterior prediction plots------
herb_bio_nutr_post_plot_total<-
herb_bio_n15_total_brms %>%
  spread_draws(b_turf_n15_c) %>%
  ggplot(aes(y = 0, x = b_turf_n15_c, fill = "#0072B2")) + #rescale so .1 mm/day
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 2, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#0072B2"),0.3))+
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
 # scale_x_continuous(limits=c(-2.5, 3), breaks=seq(-2, 3,1))+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
       # text=element_text(size=16,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_bio_nutr_post_plot_total


##combine and save---------
##make inset plots, then combine and save:
herb.bio.nutr.plot.with.inset.total <-
  ggdraw() +
  draw_plot(herb_bio_nutr_part_plot_total) +
  draw_plot(herb_bio_nutr_post_plot_total, x = 0.6, y = .06, width = .35, height = .35)
herb.bio.nutr.plot.with.inset.total



```


##combine and save all 4 panels of figure 6:
```{r}
#total:
herb.bio.nutr.plot.with.inset.total
herb.prod.nutr.plot.with.inset.total
#direct:
herb.bio.nutr.plot.with.inset
herb.prod.nutr.plot.with.inset

fig6<-plot_grid(herb.prod.nutr.plot.with.inset, herb.bio.nutr.plot.with.inset, herb.prod.nutr.plot.with.inset.total, herb.bio.nutr.plot.with.inset.total) #, labels = c("(a) Turf productivity", "(b) Turf cover"),
               #label_size = 12, label_fontface = "plain", # hjust = -1,   vjust = 1,
              #  scale = .95)
fig6


##actually, works better with patchwork to allow white space between rows:----
library(patchwork)
fig6<-herb.prod.nutr.plot.with.inset   + herb.bio.nutr.plot.with.inset + plot_spacer() +   plot_spacer() + herb.prod.nutr.plot.with.inset.total  + herb.bio.nutr.plot.with.inset.total + plot_layout(ncol = 2) + 
   plot_layout(heights = c(1, .05, 1)) & theme(plot.background = element_rect(fill = "white",color = "white"), rect = element_rect(fill = "white",color = "white")) #png saving adds weird borders to plots, but re-setting overall theme to white here solves it
fig6

ggsave(filename = "../outputs/figures/figure6_combined.png", 
       plot = fig6,
       width = 25, 
       height = 22,
       units = "cm",
       dpi = 300)



ggsave(filename = "../outputs/figures/figure6_combined.pdf", 
       plot = fig6,
       width = 25, 
       height = 22,
       units = "cm",
       dpi = 300)




```




#####--------ALTERNATIVE DAG--------------
#based on above results + correlation analysis - try second DAG wtih combination of top-down and bottom-up effects.
#still expect pp->herb bio and prod. but now check for herb bio and prod -> turf cover. 


###Hypothesis H5 - effect of turf productivity on herbivore productivity
```{r}
#now need: exposure and turf n15

#run model:----
herb_prod_turf_pp_alt_brms<-
  brm(
 log_herb_prod~turf_productivity_c  + turf_n15_c   + exposure_c + (1|Island), 
  data = trans_site_all_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/herb_prod_turf_pp_alt_brms") #all good
print(herb_prod_turf_pp_alt_brms) #worked, just 4 divergent

pp_check(herb_prod_turf_pp_alt_brms) #looks good
plot(herb_prod_turf_pp_alt_brms, ask = FALSE) #looks good

hypothesis(herb_prod_turf_pp_alt_brms, "turf_productivity_c>0") 
#4.9	13.91	-15.2	25.06	2.75	0.73	
#slightly stronger effect than in original DAG. 

herb_prod_turf_pp_alt_brms %>%
  spread_draws(b_turf_productivity_c) %>%
  median_hdi(b_turf_productivity_c/10)


herb_prod_turf_pp_alt_brms %>%
  spread_draws(b_turf_productivity_c) %>%
  median_hdi(exp(b_turf_productivity_c/10))
#1.627505	5.880498e-06	12.26595			0.95	  0.95	median	hdi

#so each .1 mm/day increase in turf growth rate, herbivore productivity increases by a factor of 1.63

```


###Hypothesis H6 - effect of turf productivity on herbivore biomass
```{r}
#same as for herbivore productivity:

#run model:----
herb_bio_turf_pp_alt_brms<-
  brm(
 log_herb_bio~turf_productivity_c  + turf_n15_c   + exposure_c + (1|Island), 
  data = trans_site_all_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/herb_bio_turf_pp_alt_brms") #all good
print(herb_bio_turf_pp_alt_brms) #worked

pp_check(herb_bio_turf_pp_alt_brms) #looks pretty good 
plot(herb_bio_turf_pp_alt_brms, ask = FALSE) #looks good


hypothesis(herb_bio_turf_pp_alt_brms, "turf_productivity_c>0") 
#5.37	21.43	-26.79	35.99	2.02	0.67	
#similar to original DAG


herb_bio_turf_pp_alt_brms %>%
  spread_draws(b_turf_productivity_c) %>%
  median_hdi(b_turf_productivity_c/10)
#0.5820589	-4.059838	4.404372

herb_bio_turf_pp_alt_brms %>%
  spread_draws(b_turf_productivity_c) %>%
  median_hdi(exp(b_turf_productivity_c/10))
#1.789719	5.298899e-08	36.57011				0.95	  0.95	median	hdi

```




####Hypothesis H7a - Effect of herbivore productivity on turf cover----
```{r}
#most robust adjustment set: exp, pp, pred, struct, tn15


#try second set (more robust to dag changes, simpler model):-----
#from previous analysis: log-log model fits best - 
turf_cover_herb_prod_total_alt_brms<-
  brm(
 log_turf_cover~  log_herb_prod_c + turf_productivity_c   + exposure_c + turf_n15_c + structure_c + log_pred_bio_c + (1|Island), 
  data = trans_site_all_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/turf_cover_herb_prod_total_alt_brms") 
print(turf_cover_herb_prod_total_alt_brms) #worked 

pp_check(turf_cover_herb_prod_total_alt_brms) #looks good
plot(turf_cover_herb_prod_total_alt_brms, ask = FALSE) #looks good

hypothesis(turf_cover_herb_prod_total_alt_brms, "log_herb_prod_c<0") 
#-0.56	0.49	-1.37	0.22	7.25	0.88	


##extract effects-----
turf_cover_herb_prod_total_alt_brms %>%
  spread_draws(b_log_herb_prod_c) %>%
  median_hdi(b_log_herb_prod_c)


#because both X and Y are log-transformed: a doubling of X is associated with a change in the median of Y by a factor of 2^B
turf_cover_herb_prod_total_alt_brms %>%
  spread_draws(b_log_herb_prod_c) %>%
  median_hdi(2^(b_log_herb_prod_c))
#0.6812666	0.2910087	1.208226					0.95	  0.95	median	hdi

#so for each doubling of herbivore biomass, prop turf cover changes by a factor of 0.69....

1-0.6812666 # 0.3187334 31.87% reduction
1-0.2910087 #0.7089913 70.90% reduction
1.208226 - 1 #0.208226 20.82% increase

```





####Hypothesis H8a - Effect of herbivore biomass on turf cover----
```{r}
#same as for herbivore productivity above: 

#run model:-----
turf_cover_herb_bio_total_alt_brms<-
  brm(
 log_turf_cover~  log_herb_bio_c + turf_productivity_c   + exposure_c + turf_n15_c + structure_c + log_pred_bio_c + (1|Island), 
  data = trans_site_all_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/turf_cover_herb_bio_total_alt_brms") 
print(turf_cover_herb_bio_total_alt_brms) #worked 

pp_check(turf_cover_herb_bio_total_alt_brms) #looks good
plot(turf_cover_herb_bio_total_alt_brms, ask = FALSE) #looks good

hypothesis(turf_cover_herb_bio_total_alt_brms, "log_herb_bio_c<0") 
#-0.5	0.5	-1.34	0.3	5.84	0.85	
#very similar to effect of herb productivity

##extract effects-----
turf_cover_herb_bio_total_alt_brms %>%
  spread_draws(b_log_herb_bio_c) %>%
  median_hdi(b_log_herb_bio_c)


#because both X and Y are log-transformed: a doubling of X is associated with a change in the median of Y by a factor of 2^B

turf_cover_herb_bio_total_alt_brms %>%
  spread_draws(b_log_herb_bio_c) %>%
  median_hdi(2^(b_log_herb_bio_c))
#0.7142291	0.3075364	1.282861					0.95	  0.95	median	hdi

#so for each doubling of herbivore biomass, prop turf cover changes by a factor of 0.71....

1-0.7142291 #0.2857709 28.58% reduction
1-0.3075364 #0.6924636 69.25% reduction
1.282861 - 1 # 0.282861 28.29% increase



```



#Hypothesis H9 and H10 - effect of turf n15 on herbivore productivity and herbivore biomass
```{r}

#total effect is same as original DAG - just control for exposure (with no connection from turf height to turf cover)
#direct effect = control for exposure and pp:

#so no need to do anything here for total----
print(herb_prod_n15_total_brms) 
print(herb_bio_n15_total_brms) 

#for direct, productivity:----
herb_prod_n15_direct_alt_brms<-
  brm(
 log_herb_prod~  turf_productivity_c   + exposure_c + turf_n15_c  + (1|Island), 
  data = trans_site_all_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/herb_prod_n15_direct_alt_brms") 
print(herb_prod_n15_direct_alt_brms) #worked - 7 divergent

pp_check(herb_prod_n15_direct_alt_brms) #looks good
plot(herb_prod_n15_direct_alt_brms, ask = FALSE) #looks good

hypothesis(herb_prod_n15_direct_alt_brms, "turf_n15_c>0") 
#-0.13	0.74	-1.25	1.03	0.69	0.41	
#quite similar to original dag - not much effect of turf n15 on herbivore prod. 


##extract effects-----
herb_prod_n15_direct_alt_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(b_turf_n15_c)


herb_prod_n15_direct_alt_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(exp(b_turf_n15_c))
#0.8623611	0.0131274	2.795977	

##biomass: direct----
herb_bio_n15_direct_alt_brms<-
  brm(
 log_herb_bio~  turf_productivity_c   + exposure_c + turf_n15_c  + (1|Island), 
  data = trans_site_all_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/herb_bio_n15_direct_alt_brms") 
print(herb_bio_n15_direct_alt_brms) #worked 



pp_check(herb_bio_n15_direct_alt_brms) #looks good
plot(herb_bio_n15_direct_alt_brms, ask = FALSE) #looks good

hypothesis(herb_bio_n15_direct_alt_brms, "turf_n15_c>0") 
#0.13	0.99	-1.39	1.62	1.31		0.57	

##extract effects-----
herb_bio_n15_direct_alt_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(b_turf_n15_c)
#0.1298932	-1.865465	2.108835	

herb_bio_n15_direct_alt_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(exp(b_turf_n15_c))
#1.138707	0.00215411	5.070375	


```


#Hypothesis H3 - effect of turf n15 on turf cover
```{r}
#only care about total effect, becaue now know it goes via PP then herbivores. 
#this is the same as original DAG - just control for exposure
#from other file: 
turf_cover_nutrients_brms<-readRDS(file = "../outputs/brms/turf_cover_nutrients_brms.RDS") #all good

print(turf_cover_nutrients_brms)

hypothesis(turf_cover_nutrients_brms, "turf_n15_c<0") 
#-0.39	0.42	-1.06	0.3	5.31	0.84	
#so just opposite of previous one where tested for positive effect of turf n15 on turf cover


```


###---------MODEL PLOTS FOR ALTERNATIVE DAG----------
```{r}

###effects of turf PP on herbivore productivity:-----
herb_prod_turf_pp_plot_alt<-
herb_prod_turf_pp_alt_brms %>%
  spread_draws(b_turf_productivity_c) %>%
  ggplot(aes(y = 0, x = b_turf_productivity_c/10, fill = after_stat(x < 0))) + #rescale to reasonable estimates
  stat_halfeye(point_interval=median_hdci, .width=c(.95, .75), fatten_point = 1, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#d0e2af" ,"#e89c81"),1)) +#PNW color palette
  geom_vline(xintercept = 0, linetype = "dashed") +
     scale_x_continuous(limits=c(-8, 10), breaks=seq(-5, 5,5))+
  theme_bw() + 
  xlab("")+
  ylab("")+
  #ggtitle("effect of turf nutrients on turf productivity")+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
        text=element_text(size=10,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_prod_turf_pp_plot_alt

#Save the plot with ggsave()
ggsave(filename = "../outputs/figures/herb_prod_turf_pp_plot_alt.pdf", plot = herb_prod_turf_pp_plot_alt,  width = 8,   height = 5,  units = "cm", dpi = 300)



###effects of turf PP on herbivore biomass:-----
herb_bio_turf_pp_plot_alt<-
herb_bio_turf_pp_alt_brms %>%
  spread_draws(b_turf_productivity_c) %>%
  ggplot(aes(y = 0, x = b_turf_productivity_c/10, fill = after_stat(x < 0))) + #re-scale to reasonable estimates 
  stat_halfeye(point_interval=median_hdci, .width=c(.95, .75), fatten_point = 1, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#d0e2af" ,"#e89c81"),1)) +#PNW color palette
  geom_vline(xintercept = 0, linetype = "dashed") +
     scale_x_continuous(limits=c(-10, 12), breaks=seq(-5, 5,5))+
  theme_bw() + 
  xlab("")+
  ylab("")+
  #ggtitle("effect of turf nutrients on turf productivity")+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
        text=element_text(size=10,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_bio_turf_pp_plot_alt

#Save the plot with ggsave()
ggsave(filename = "../outputs/figures/herb_bio_turf_pp_plot_alt.pdf", plot = herb_bio_turf_pp_plot_alt,  width = 8,   height = 5,  units = "cm", dpi = 300)


###effects of herbivore prod on turf cover:-----
turf_cover_herb_prod_post_plot_alt<-
turf_cover_herb_prod_total_alt_brms %>%
  spread_draws(b_log_herb_prod_c) %>%
  ggplot(aes(y = 0, x = b_log_herb_prod_c, fill = after_stat(x < 0))) +
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 1, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#d0e2af" ,"#e89c81"),1)) +#PNW color palette
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
  #ggtitle("effect of turf nutrients on turf productivity")+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
        text=element_text(size=10,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
turf_cover_herb_prod_post_plot_alt

#Save the plot with ggsave()
ggsave(filename = "../outputs/figures/turf_cover_herb_prod_post_plot_alt.pdf", plot = turf_cover_herb_prod_post_plot_alt,  width = 8,   height = 5,  units = "cm", dpi = 300)




###effects of herbivore bio on turf cover:-----
turf_cover_herb_bio_post_plot_alt<-
turf_cover_herb_bio_total_alt_brms %>%
  spread_draws(b_log_herb_bio_c) %>%
  ggplot(aes(y = 0, x = b_log_herb_bio_c, fill = after_stat(x < 0))) +
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 1, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#d0e2af" ,"#e89c81"),1)) +#PNW color palette
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
  #ggtitle("effect of turf nutrients on turf productivity")+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
        text=element_text(size=10,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
turf_cover_herb_bio_post_plot_alt

#Save the plot with ggsave()
ggsave(filename = "../outputs/figures/turf_cover_herb_bio_post_plot_alt.pdf", plot = turf_cover_herb_bio_post_plot_alt,  width = 8,   height = 5,  units = "cm", dpi = 300)



###effects of turf n15 on turf cover:-----
turf_cover_turfn15_plot_alt<-
turf_cover_nutrients_brms %>%
  spread_draws(b_turf_n15_c) %>%
  ggplot(aes(y = 0, x = b_turf_n15_c, fill = after_stat(x < 0))) +
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .5), fatten_point = 1, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#d0e2af" ,"#e89c81"),1)) +#PNW color palette
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
  #ggtitle("effect of turf nutrients on turf productivity")+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
        text=element_text(size=10,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
turf_cover_turfn15_plot_alt

#Save the plot with ggsave()
ggsave(filename = "../outputs/figures/turf_cover_turfn15_plot_alt.pdf", plot = turf_cover_turfn15_plot_alt,  width = 8,   height = 5,  units = "cm", dpi = 300)


###effects of turf n15 on herb prod:-----
herb_prod_turfn15_total_plot_alt<-
herb_prod_n15_total_brms %>%
  spread_draws(b_turf_n15_c) %>%
  ggplot(aes(y = 0, x = b_turf_n15_c, fill = after_stat(x < 0))) +
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .5), fatten_point = 1, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#d0e2af" ,"#e89c81"),1)) +#PNW color palette
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
  #ggtitle("effect of turf nutrients on turf productivity")+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
        text=element_text(size=10,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_prod_turfn15_total_plot_alt

#Save the plot with ggsave()
ggsave(filename = "../outputs/figures/herb_prod_turfn15_total_plot_alt.pdf", plot = herb_prod_turfn15_total_plot_alt,  width = 8,   height = 5,  units = "cm", dpi = 300)




###effects of turf n15 on herb bio:-----
herb_bio_turfn15_total_plot_alt<-
herb_bio_n15_total_brms %>%
  spread_draws(b_turf_n15_c) %>%
  ggplot(aes(y = 0, x = b_turf_n15_c, fill = after_stat(x < 0))) +
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .5), fatten_point = 1, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#d0e2af" ,"#e89c81"),1)) +#PNW color palette
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
  #ggtitle("effect of turf nutrients on turf productivity")+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
        text=element_text(size=10,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_bio_turfn15_total_plot_alt

#Save the plot with ggsave()
ggsave(filename = "../outputs/figures/herb_bio_turfn15_total_plot_alt.pdf", plot = herb_bio_turfn15_total_plot_alt,  width = 8,   height = 5,  units = "cm", dpi = 300)


```





