---
title: "turf-prod-cover-vs-herbivores"
author: "CEB"
date: '2024-09-05'
output: html_document
---

#load packages
```{r}
library(tidyverse)

#for bayesian analysis:
library(brms)
library(tidybayes)

#for plotting:
library(cowplot)

library(jtools)

```


###set plot theme
```{r}
theme_casey<-
  theme_bw()+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        text = element_text(size = 14, family = "Arial"),
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA)
        )

theme_set(theme_casey) 
  
```


#load  data and combine
```{r}
#turf cover and nutrient data----
turf_cover_iso_dat<-read.csv("../data/seychelles_turf_cover_isotopes_by_transect.csv")

#turf growth data---
turf_growth_iso_dat<-read.csv("../data/seychelles_turf_pp_iso_by_cage.csv")
#aggregate by site:
turf_growth_iso_site_dat<-
  turf_growth_iso_dat%>%
    group_by(Island, Site)%>%
  summarize(mean_turf_prod_mm_day = mean(Turf_growth_mm_per_day, na.rm = TRUE),
            se_turf_prod_mm_day = sd(Turf_growth_mm_per_day, na.rm = TRUE)/sqrt(length(Turf_growth_mm_per_day)))
turf_growth_iso_site_dat

#herbivore info (from productivity calculations file)----
herbivore_dat<-read.csv("../data/seychelles_herbivore_biomass_productivity_by_transect.csv")

#combine---
str(turf_cover_iso_dat)
str(herbivore_dat)

#first turf cover with turf growth (nutrients should match)
turf_all_dat<-left_join(turf_cover_iso_dat, turf_growth_iso_site_dat, 
                                    by =c("Island", "Site"))
turf_all_dat

herbivore_turf_dat<-left_join(herbivore_dat, turf_all_dat,
                                    by =c("Island", "Site", "Transect"))
herbivore_turf_dat

```



####Bayesian analysis based on DAGs - Hypothesis 7: effect of turf cover on herbivore productivity----
```{r}

#add column for centered, log data:----
herbivore_turf_dat_c<-
  herbivore_turf_dat%>%
  mutate(turf_n15_c = base::scale(mean_turf_n15, center = TRUE, scale = FALSE),
         turf_prop_c = base::scale(turf_prop, center = TRUE, scale = FALSE),
         turf_productivity_c = base::scale(mean_turf_prod_mm_day, center = TRUE, scale = FALSE),
         log_herb_bio = log(herb_biomass_kg_ha),
         log_herb_prod = log(herb_productivity_kg_ha_day))
herbivore_turf_dat_c

#brms models------
#see previous file for other options/build-up

#log-log model, uninformative prior: 
herb_prod_turf_cover_brms<-
  brm(
 log_herb_prod~turf_n15_c + turf_prop_c +(1|Island), #based on DAG, need to also account for turf nutrients to get both total and direct effect of turf cover on herbivore biomass, productivity
  data = herbivore_turf_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/herb_prod_turf_cover_brms") #all good
print(herb_prod_turf_cover_brms) #worked

pp_check(herb_prod_turf_cover_brms) #looks good
plot(herb_prod_turf_cover_brms) #looks good

hypothesis(herb_prod_turf_cover_brms, "turf_prop_c>0") 
  #hypothesis              est      error     lower     upper       evidence ratio        posterior probability
  #(turf_prop_c) > 0      	-0.91	  1.27	  -2.99       	1.12        	0.3	                    0.23	
#so if anything, NEGATIVE effect of turf cover on herbivore productivity


#no need to set more informative priors because sampling worked well, plus don't have good prior knowledge for this. So proceed with this model

#extract some values:------
herb_prod_turf_cover_brms %>%
  spread_draws(b_turf_prop_c) %>%
  median_hdi(b_turf_prop_c)
#b_log_seabird      lower       upper     width   point     interval
# -0.8964921	      -3.392087	  1.62323		0.95	median	hdi


#because Y is log-transformed: an increase of one unit in X is associated with a change in the median of Y by a factor of exp(B)
#but estimates are crazy because increase in proportional turf by 1 unit is super high, so divide to make it .1 proportional increase (so 10% increase):

herb_prod_turf_cover_brms %>%
  spread_draws(b_turf_prop_c) %>%
  median_hdi(exp(b_turf_prop_c/10))
#0.9142518	0.7012978	1.159857		  0.95	median	hdi

#so each 10% increase in turf cover results in decrease in herbivore biomass by a factor of 0.93. Or:
1-0.9142518 #0.0857482: 8.6% decrease
1-0.7012978 #0.2987022: 30% decrease
1.159857-1 #0.159857: 16% increase

```


#plots for turf cover vs. herbivore productivity
```{r}
#plot partialized residuals-----
me_herb_prod_cover<-conditional_effects(herb_prod_turf_cover_brms, prob = .75, effects = 'turf_prop_c', plot = FALSE)[[1]]

#extract partialized residuals
p_herb_prod_cover<-partialize(herb_prod_turf_cover_brms, vars= "turf_prop_c",  data = herbivore_turf_dat_c)


#back-transform growth, centered/scaled n15:----
#get data for un-scaling and centering:
mean(herbivore_turf_dat_c$turf_prop, na.rm=TRUE) #0.135

me_herb_prod_cover_unscale<-
  me_herb_prod_cover%>%
  mutate(turf_prop = turf_prop_c + 0.135 ) # + mean


herb_prod_cover_part_plot<-
p_herb_prod_cover %>%
  ggplot(aes(x = turf_prop, y = log_herb_prod)) +
     geom_point(color = "#EE7733", fill = "#EE7733",  alpha = 0.4, size = 3) + #, size = .8, width=.07,
    geom_ribbon(data = me_herb_prod_cover_unscale, aes(ymin =(lower__), ymax=(upper__)), alpha = .2, fill = "#EE7733")+
    geom_line(data = me_herb_prod_cover_unscale, aes(y = (estimate__)), lwd = 1.2, colour = "#EE7733") +
  ylab(bquote(Herbivore~productivity~(log~kg~ha^-1~day^-1)))+
xlab("Turf (proportional cover)")+
  theme_bw()+
    guides(size = "none", colour = "none",  fill = guide_legend(title="Confidence level")) + 
    theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
    #            text = element_text(size = 24),
        legend.position='none')
herb_prod_cover_part_plot




#posterior prediction plots------
herb_prod_cover_post_plot<-
herb_prod_turf_cover_brms %>%
  spread_draws(b_turf_prop_c) %>%
  ggplot(aes(y = 0, x = b_turf_prop_c, fill = "#EE7733")) +
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 2, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#EE7733"),0.3))+
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
 # scale_x_continuous( breaks=c(0,1,2), labels =c("0.0", "1.0", "2.0"))+
 # scale_x_continuous(breaks=seq(-.5, .5,.5))+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
       # text=element_text(size=16,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_prod_cover_post_plot


##combine and save---------
##make inset plots, then combine and save:
herb.prod.cover.plot.with.inset <-
  ggdraw() +
  draw_plot(herb_prod_cover_part_plot) +
  draw_plot(herb_prod_cover_post_plot, x = 0.6, y = .64, width = .35, height = .35)
herb.prod.cover.plot.with.inset

#Save the plot with ggsave()
#ggsave(filename = "../outputs/figures/figure4c_herbivore_productivity_vs_turf_cover.png", 
#       plot = herb.prod.cover.plot.with.inset,
#       width = 11,
#       height = 7.5,
#       units = "cm",
#       dpi = 300)


```



####Bayesian analysis based on DAGs - Hypothesis 8: effect of turf cover on herbivore biomass----
```{r}

#brms models------
#see previous file for other options/build-up

#log-log model, uninformative prior: 
herb_bio_turf_cover_brms<-
  brm(
 log_herb_bio~turf_n15_c + turf_prop_c +(1|Island), #based on DAG, need to also account for turf nutrients to get both total and direct effect of turf cover on herbivore biomass, biouctivity
  data = herbivore_turf_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/herb_bio_turf_cover_brms") #1 divergent trans...may set intercept prior to help
print(herb_bio_turf_cover_brms)

pp_check(herb_bio_turf_cover_brms) #looks good
plot(herb_bio_turf_cover_brms) #looks good

hypothesis(herb_bio_turf_cover_brms, "turf_prop_c>0") 
  #hypothesis              est      error     lower     upper       evidence ratio        posterior probability
  #(turf_prop_c) > 0      	-0.69	  1.32	    -2.88	      1.42        	0.41	              0.29	
#so if anything, NEGATIVE effect of turf cover on herbivore biouctivity


#extract some values:------
herb_bio_turf_cover_brms %>%
  spread_draws(b_turf_prop_c) %>%
  median_hdi(b_turf_prop_c)
#b_log_seabird      lower       upper     width   point     interval
# -0.6628445     	-3.328997	  1.885944			0.95	median	hdi

#because Y is log-transformed: an increase of one unit in X is associated with a change in the median of Y by a factor of exp(B)
#but estimates are crazy because increase in proportional turf by 1 unit is super high, so divide to make it .1 proportional increase (so 10% increase):

herb_bio_turf_cover_brms %>%
  spread_draws(b_turf_prop_c) %>%
  median_hdi(exp(b_turf_prop_c/10))
#0.9358646	    0.7001586	    1.184626	  0.95	median	hdi

#so each 10% increase in turf cover results in decrease in herbivore biomass by a factor of 0.93. Or:
1-0.9358646 #0.0641354: 6.4% decrease
1-0.7001586 #0.2998414: 30% decrease
1.184626-1 #0.184626: 18.5% increase

```



#plots for turf cover vs. herbivore biomass
```{r}
#plot partialized residuals-----
me_herb_bio_cover<-conditional_effects(herb_bio_turf_cover_brms, prob = .75, effects = 'turf_prop_c', plot = FALSE)[[1]]

#extract partialized residuals
p_herb_bio_cover<-partialize(herb_bio_turf_cover_brms, vars= "turf_prop_c",  data = herbivore_turf_dat_c)


#back-transform growth, centered/scaled n15:----
#get data for un-scaling and centering:
mean(herbivore_turf_dat_c$turf_prop, na.rm=TRUE) #0.135

me_herb_bio_cover_unscale<-
  me_herb_bio_cover%>%
  mutate(turf_prop = turf_prop_c + 0.135 ) # + mean


herb_bio_cover_part_plot<-
p_herb_bio_cover %>%
  ggplot(aes(x = turf_prop, y = log_herb_bio)) +
     geom_point(color = "#0072B2", fill = "#0072B2",  alpha = 0.4, size = 3) + #, size = .8, width=.07,
    geom_ribbon(data = me_herb_bio_cover_unscale, aes(ymin =(lower__), ymax=(upper__)), alpha = .2, fill = "#0072B2")+
    geom_line(data = me_herb_bio_cover_unscale, aes(y = (estimate__)), lwd = 1.2, colour = "#0072B2") +
  ylab(bquote(Herbivore~biomass~(log~kg~ha^-1)))+
xlab("Turf (proportional cover)")+
  theme_bw()+
    guides(size = "none", colour = "none",  fill = guide_legend(title="Confidence level")) + 
    theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
    #            text = element_text(size = 24),
        legend.position='none')
herb_bio_cover_part_plot




#posterior prediction plots------
herb_bio_cover_post_plot<-
herb_bio_turf_cover_brms %>%
  spread_draws(b_turf_prop_c) %>%
  ggplot(aes(y = 0, x = b_turf_prop_c, fill = "#0072B2")) +
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 2, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#0072B2"),0.3))+
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
 # scale_x_continuous( breaks=c(0,1,2), labels =c("0.0", "1.0", "2.0"))+
 # scale_x_continuous(breaks=seq(-.5, .5,.5))+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
       # text=element_text(size=16,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_bio_cover_post_plot


##combine and save---------
##make inset plots, then combine and save:
herb.bio.cover.plot.with.inset <-
  ggdraw() +
  draw_plot(herb_bio_cover_part_plot) +
  draw_plot(herb_bio_cover_post_plot, x = 0.6, y = .07, width = .35, height = .35)
herb.bio.cover.plot.with.inset


# Can save the plot with ggsave()
#ggsave(filename = "../outputs/figures/figure4d_herbivore_biomass_vs_turf_cover.png", 
#       plot = herb.bio.cover.plot.with.inset,
#       width = 11,
#       height = 7.5,
#       units = "cm",
#       dpi = 300)


```


####Bayesian analysis based on DAGs - Hypothesis 5: effect of turf productivity on herbivore productivity----
```{r}

#brms models------
#see previous file for other options/build-up

#log-log model, uninformative prior: 
herb_prod_turf_prod_brms<-
  brm(
 log_herb_prod~turf_n15_c + turf_productivity_c +(1|Island), #based on DAG, need to also account for turf nutrients to get both total and direct effect of turf cover on herbivore biomass, productivity
  data = herbivore_turf_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/herb_prod_turf_prod_brms") #1 divergent trans
print(herb_prod_turf_prod_brms) #worked

pp_check(herb_prod_turf_prod_brms) #looks good
plot(herb_prod_turf_prod_brms) #looks good

hypothesis(herb_prod_turf_prod_brms, "turf_productivity_c>0") 
  #hypothesis                est      error     lower     upper       evidence ratio        posterior probability
  #(turf_productivit... > 0	4.64	    8.91	    -7.2	    17.29	          4.33	                  0.81
#positive effect of turf productivity on herbivore productivity


#extract some values:------
herb_prod_turf_prod_brms %>%
  spread_draws(b_turf_productivity_c) %>%
  median_hdi(b_turf_productivity_c)
#b_log_seabird      lower       upper     width   point     interval
# 4.406229	        -12.72247	22.87873			0.95	median	hdi


herb_prod_turf_prod_brms %>%
  spread_draws(b_turf_productivity_c) %>%
  median_hdi(exp(b_turf_productivity_c/10)) #estimates look crazy! because 1 mm/day increase in turf is super high...
#divide to make it .1 mm/day increase:
#exp(b_N15_in_cs)             lower       upper     width   point     interval
#1.553675	                0.0004898777  	5.642395				0.95	median	hdi


```


#plots for turf productivity vs. herbivore productivity
```{r}
#plot partialized residuals-----
me_herb_prod_pp<-conditional_effects(herb_prod_turf_prod_brms, prob = .75, effects = 'turf_productivity_c', plot = FALSE)[[1]]

#extract partialized residuals
p_herb_prod_pp<-partialize(herb_prod_turf_prod_brms, vars= "turf_productivity_c",  data = herbivore_turf_dat_c)


#back-transform growth, centered/scaled n15:----
#get data for un-scaling and centering:
mean(herbivore_turf_dat_c$mean_turf_prod_mm_day, na.rm=TRUE) #0.3158526

me_herb_prod_pp_unscale<-
  me_herb_prod_pp%>%
  mutate(mean_turf_prod_mm_day = turf_productivity_c + 0.3158526 ) # + mean


herb_prod_pp_part_plot<-
p_herb_prod_pp %>%
  ggplot(aes(x = mean_turf_prod_mm_day, y = log_herb_prod)) +
     geom_point(color = "#EE7733", fill = "#EE7733",  alpha = 0.4, size = 3) + #, size = .8, width=.07,
    geom_ribbon(data = me_herb_prod_pp_unscale, aes(ymin =(lower__), ymax=(upper__)), alpha = .2, fill = "#EE7733")+
    geom_line(data = me_herb_prod_pp_unscale, aes(y = (estimate__)), lwd = 1.2, colour = "#EE7733") +
  ylab(bquote(Herbivore~productivity~(log~kg~ha^-1~day^-1)))+
  xlab(bquote(Turf~productivity~(mm~day^-1)))+
  theme_bw()+
    guides(size = "none", colour = "none",  fill = guide_legend(title="Confidence level")) + 
    theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
    #            text = element_text(size = 24),
        legend.position='none')
herb_prod_pp_part_plot




#posterior prediction plots------
herb_prod_pp_post_plot<-
herb_prod_turf_prod_brms %>%
  spread_draws(b_turf_productivity_c) %>%
  ggplot(aes(y = 0, x = b_turf_productivity_c/10, fill = "#EE7733")) + #rescale so .1 mm/day
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 2, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#EE7733"),0.3))+
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
  scale_x_continuous(limits=c(-2.5, 3), breaks=seq(-2, 3,1))+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
       # text=element_text(size=16,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_prod_pp_post_plot


##combine and save---------
##make inset plots, then combine and save:
herb.prod.pp.plot.with.inset <-
  ggdraw() +
  draw_plot(herb_prod_pp_part_plot) +
  draw_plot(herb_prod_pp_post_plot, x = 0.1, y = .64, width = .35, height = .35)
herb.prod.pp.plot.with.inset

#Save the plot with ggsave()
#ggsave(filename = "../outputs/figures/figure4a_herbivore_productivity_vs_turf_productivity.png", 
#       plot = herb.prod.pp.plot.with.inset,     width = 11,      height = 7.5,      units = "cm",      dpi = 300)


```




####Bayesian analysis based on DAGs - Hypothesis 6: effect of turf productivity on herbivore biomass----
```{r}

#brms models------
#see previous file for other options/build-up

#log-log model, uninformative prior: 
herb_bio_turf_prod_brms<-
  brm(
 log_herb_bio~turf_n15_c + turf_productivity_c +(1|Island), #based on DAG, need to also account for turf nutrients to get both total and direct effect of turf cover on herbivore biomass, productivity
  data = herbivore_turf_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/herb_bio_turf_prod_brms") 
print(herb_bio_turf_prod_brms) #worked

pp_check(herb_bio_turf_prod_brms) #looks good
plot(herb_bio_turf_prod_brms) #looks good

hypothesis(herb_bio_turf_prod_brms, "turf_productivity_c>0") 
  #hypothesis                est      error     lower     upper       evidence ratio        posterior probability
  #(turf_biouctivit... > 0	6.41    	13.73	  -14.7	        27.43	      3.17	                  0.76	
#positive effect of turf productivity on herbivore biomass


#extract some values:------
herb_bio_turf_prod_brms %>%
  spread_draws(b_turf_productivity_c) %>%
  median_hdi(b_turf_productivity_c)
#b_log_seabird      lower       upper     width   point     interval
# 6.683331      	-21.97935	  35.29537				0.95	median	hdi


herb_bio_turf_prod_brms %>%
  spread_draws(b_turf_productivity_c) %>%
  median_hdi(exp(b_turf_productivity_c/10)) #estimates look crazy! because 1 mm/day increase in turf is super high...
#divide to make it .1 mm/day increase:
#exp(b_N15_in_cs)             lower       upper     width   point     interval
#1.950983	                  1.073161e-05	15.53457				0.95	median	hdi


```


#plots for turf productivity vs. herbivore biomass
```{r}
#plot partialized residuals-----
me_herb_bio_pp<-conditional_effects(herb_bio_turf_prod_brms, prob = .75, effects = 'turf_productivity_c', plot = FALSE)[[1]]

#extract partialized residuals
p_herb_bio_pp<-partialize(herb_bio_turf_prod_brms, vars= "turf_productivity_c",  data = herbivore_turf_dat_c)


#back-transform growth, centered/scaled n15:----
#get data for un-scaling and centering:
mean(herbivore_turf_dat_c$mean_turf_prod_mm_day, na.rm=TRUE) #0.3158526

me_herb_bio_pp_unscale<-
  me_herb_bio_pp%>%
  mutate(mean_turf_prod_mm_day = turf_productivity_c + 0.3158526 ) # + mean


herb_bio_pp_part_plot<-
p_herb_bio_pp %>%
  ggplot(aes(x = mean_turf_prod_mm_day, y = log_herb_bio)) +
     geom_point(color = "#0072B2", fill = "#0072B2",  alpha = 0.4, size = 3) + #, size = .8, width=.07,
    geom_ribbon(data = me_herb_bio_pp_unscale, aes(ymin =(lower__), ymax=(upper__)), alpha = .2, fill = "#0072B2")+
    geom_line(data = me_herb_bio_pp_unscale, aes(y = (estimate__)), lwd = 1.2, colour = "#0072B2") +
  ylab(bquote(Herbivore~biomass~(log~kg~ha^-1)))+
  xlab(bquote(Turf~productivity~(mm~day^-1)))+
  theme_bw()+
    guides(size = "none", colour = "none",  fill = guide_legend(title="Confidence level")) + 
    theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
    #            text = element_text(size = 24),
        legend.position='none')
herb_bio_pp_part_plot




#posterior prediction plots------
herb_bio_pp_post_plot<-
herb_bio_turf_prod_brms %>%
  spread_draws(b_turf_productivity_c) %>%
  ggplot(aes(y = 0, x = b_turf_productivity_c/10, fill = "#0072B2")) + #rescale so .1 mm/day
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 2, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#0072B2"),0.3))+
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
  scale_x_continuous(limits=c(-5, 5), breaks=seq(-5, 5,2.5))+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
       # text=element_text(size=16,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_bio_pp_post_plot


##combine and save---------
##make inset plots, then combine and save:
herb.bio.pp.plot.with.inset <-
  ggdraw() +
  draw_plot(herb_bio_pp_part_plot) +
  draw_plot(herb_bio_pp_post_plot, x = 0.6, y = .07, width = .35, height = .35)
herb.bio.pp.plot.with.inset

#Save the plot with ggsave()
#ggsave(filename = "../outputs/figures/figure4b_herbivore_biomass_vs_turf_productivity.png", 
#      plot = herb.bio.pp.plot.with.inset,     width = 11,      height = 7.5,      units = "cm",      dpi = 300)


```


##combine and save all 4 panels of figure 4:
```{r}
herb.bio.pp.plot.with.inset
herb.prod.pp.plot.with.inset
herb.bio.cover.plot.with.inset
herb.prod.cover.plot.with.inset


##actually, works better with patchwork to allow white space between rows:----
library(patchwork)
fig4<-herb.prod.pp.plot.with.inset   + herb.bio.pp.plot.with.inset + plot_spacer() +   plot_spacer() + herb.prod.cover.plot.with.inset  + herb.bio.cover.plot.with.inset + plot_layout(ncol = 2) + 
   plot_layout(heights = c(1, .05, 1)) & theme(plot.background = element_rect(fill = "white",color = "white"), rect = element_rect(fill = "white",color = "white")) #png saving adds weird borders to plots, but re-setting overall theme to white here solves it
fig4

ggsave(filename = "../outputs/figures/figure4_combined.png", 
       plot = fig4,
       width = 25, 
       height = 22,
       units = "cm",
       dpi = 300)



ggsave(filename = "../outputs/figures/figure4_combined.pdf", 
       plot = fig4,
       width = 25, 
       height = 22,
       units = "cm",
       dpi = 300)




```

####Bayesian analysis based on DAGs - Hypothesis 9a: DIRECT effect of turf nutrients on herbivore productivity----
```{r}
#Need to close biasing paths by including turf productivity and turf cover**

#brms models------
#see previous file for other options/build-up

#log-log model, uninformative prior: 
herb_prod_turf_nutr_brms<-
  brm(
 log_herb_prod~turf_n15_c + turf_productivity_c + turf_prop_c+ (1|Island), #based on DAG, need to also account for turf nutrients to get both total and direct effect of turf cover on herbivore biomass, productivity
  data = herbivore_turf_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/herb_prod_turf_nutr_brms") #3 divergent trans
print(herb_prod_turf_nutr_brms) 

pp_check(herb_prod_turf_nutr_brms) #looks good
plot(herb_prod_turf_nutr_brms) #looks good

hypothesis(herb_prod_turf_nutr_brms, "turf_n15_c>0") 
  #hypothesis                est      error     lower     upper       evidence ratio        posterior probability
  #(turf_productivit... > 0	-0.13	      0.48	  -0.88   	0.64          	0.53	            0.35	
#weak effect - if anything negative direct effect of turf nutrients on herbivore productivity


#extract some values:------
herb_prod_turf_nutr_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(b_turf_n15_c)
#b_log_seabird      lower       upper     width   point     interval
#-0.1411757	    -1.132422	    0.8305167	  0.95	median	hdi


herb_prod_turf_nutr_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(exp(b_turf_n15_c)) 
#exp(b_N15_in_cs)             lower       upper     width   point     interval
#0.8683367                  	0.2294591	  1.989134				0.95	median	hdi


##model plots-----
#plot partialized residuals-----
me_herb_prod_nutr<-conditional_effects(herb_prod_turf_nutr_brms, prob = .75, effects = 'turf_n15_c', plot = FALSE)[[1]]

#extract partialized residuals
p_herb_prod_nutr<-partialize(herb_prod_turf_nutr_brms, vars= "turf_n15_c",  data = herbivore_turf_dat_c)


#back-transform growth, centered/scaled n15:----
#get data for un-scaling and centering:
mean(herbivore_turf_dat_c$mean_turf_n15, na.rm=TRUE) #4.653333

me_herb_prod_nutr_unscale<-
  me_herb_prod_nutr%>%
  mutate(mean_turf_n15 = turf_n15_c + 4.653333 ) # + mean


herb_prod_nutr_part_plot<-
p_herb_prod_nutr %>%
  ggplot(aes(x = mean_turf_n15, y = log_herb_prod)) +
     geom_point(color = "#EE7733", fill = "#EE7733",  alpha = 0.4, size = 3) + #, size = .8, width=.07,
    geom_ribbon(data = me_herb_prod_nutr_unscale, aes(ymin =(lower__), ymax=(upper__)), alpha = .2, fill = "#EE7733")+
    geom_line(data = me_herb_prod_nutr_unscale, aes(y = (estimate__)), lwd = 1.2, colour = "#EE7733") +
  ylab(bquote(Herbivore~productivity~(log~kg~ha^-1~day^-1)))+
xlab(expression(paste("Turf ", delta^15, "N"))) + 
  theme_bw()+
    guides(size = "none", colour = "none",  fill = guide_legend(title="Confidence level")) + 
    theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
    #            text = element_text(size = 24),
        legend.position='none')
herb_prod_nutr_part_plot




#posterior prediction plots------
herb_prod_nutr_post_plot<-
herb_prod_turf_nutr_brms %>%
  spread_draws(b_turf_n15_c) %>%
  ggplot(aes(y = 0, x = b_turf_n15_c, fill = "#EE7733")) + #rescale so .1 mm/day
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 2, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#EE7733"),0.3))+
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
 # scale_x_continuous(limits=c(-2.5, 3), breaks=seq(-2, 3,1))+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
       # text=element_text(size=16,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_prod_nutr_post_plot


##combine and save---------
##make inset plots, then combine and save:
herb.prod.nutr.plot.with.inset <-
  ggdraw() +
  draw_plot(herb_prod_nutr_part_plot) +
  draw_plot(herb_prod_nutr_post_plot, x = 0.6, y = .64, width = .35, height = .35)
herb.prod.nutr.plot.with.inset

#Save the plot with ggsave()
#ggsave(filename = "../outputs/figures/figure6a_herbivore_productivity_vs_turf_nutrients_direct.png", 
#       plot = herb.prod.nutr.plot.with.inset,     width = 11,      height = 7.5,      units = "cm",      dpi = 300)


```


####Bayesian analysis based on DAGs - Hypothesis 9b: TOTAL effect of turf nutrients on herbivore productivity----
```{r}
#No additional explanatory variables needed*

#brms models------
#see previous file for other options/build-up

#log-log model, uninformative prior: 
herb_prod_turf_nutr_total_brms<-
  brm(
 log_herb_prod~turf_n15_c + (1|Island), #based on DAG, need to also account for turf nutrients to get both total and direct effect of turf cover on herbivore biomass, productivity
  data = herbivore_turf_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/herb_prod_turf_nutr_total_brms") #2 divergent trans
print(herb_prod_turf_nutr_total_brms) 

pp_check(herb_prod_turf_nutr_total_brms) #looks good
plot(herb_prod_turf_nutr_total_brms) #looks good

hypothesis(herb_prod_turf_nutr_total_brms, "turf_n15_c>0") 
  #hypothesis                est      error     lower     upper       evidence ratio        posterior probability
  #(turf_productivit... > 0	  0.13    	0.25    	-0.28 	0.54        	2.54	                  0.72		
#weak positive total effect of turf nutrients on herbivore productivity (opposite of direct)


#extract some values:------
herb_prod_turf_nutr_total_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(b_turf_n15_c)
#b_log_seabird      lower       upper     width   point     interval
#0.1281924	-0.3915975	0.6401315				  0.95	median	hdi


herb_prod_turf_nutr_total_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(exp(b_turf_n15_c)) 
#exp(b_N15_in_cs)             lower       upper     width   point     interval
#1.136772	                  0.6156629	  1.792104					0.95	median	hdi


##model plots-----
#plot partialized residuals-----
me_herb_prod_nutr_total<-conditional_effects(herb_prod_turf_nutr_total_brms, prob = .75, effects = 'turf_n15_c', plot = FALSE)[[1]]

#extract partialized residuals
p_herb_prod_nutr_total<-partialize(herb_prod_turf_nutr_total_brms, vars= "turf_n15_c",  data = herbivore_turf_dat_c)


#back-transform growth, centered/scaled n15:----
#get data for un-scaling and centering:
mean(herbivore_turf_dat_c$mean_turf_n15, na.rm=TRUE) #4.653333

me_herb_prod_nutr_total_unscale<-
  me_herb_prod_nutr_total%>%
  mutate(mean_turf_n15 = turf_n15_c + 4.653333 ) # + mean


herb_prod_nutr_part_plot_total<-
p_herb_prod_nutr_total %>%
  ggplot(aes(x = mean_turf_n15, y = log_herb_prod)) +
     geom_point(color = "#EE7733", fill = "#EE7733",  alpha = 0.4, size = 3) + #, size = .8, width=.07,
    geom_ribbon(data = me_herb_prod_nutr_total_unscale, aes(ymin =(lower__), ymax=(upper__)), alpha = .2, fill = "#EE7733")+
    geom_line(data = me_herb_prod_nutr_total_unscale, aes(y = (estimate__)), lwd = 1.2, colour = "#EE7733") +
  ylab(bquote(Herbivore~productivity~(log~kg~ha^-1~day^-1)))+
xlab(expression(paste("Turf ", delta^15, "N"))) + 
  theme_bw()+
    guides(size = "none", colour = "none",  fill = guide_legend(title="Confidence level")) + 
    theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
    #            text = element_text(size = 24),
        legend.position='none')
herb_prod_nutr_part_plot_total




#posterior prediction plots------
herb_prod_nutr_post_plot_total<-
herb_prod_turf_nutr_total_brms %>%
  spread_draws(b_turf_n15_c) %>%
  ggplot(aes(y = 0, x = b_turf_n15_c, fill = "#EE7733")) + #rescale so .1 mm/day
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 2, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#EE7733"),0.3))+
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
 # scale_x_continuous(limits=c(-2.5, 3), breaks=seq(-2, 3,1))+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
       # text=element_text(size=16,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_prod_nutr_post_plot_total


##combine and save---------
##make inset plots, then combine and save:
herb.prod.nutr.plot.with.inset.total <-
  ggdraw() +
  draw_plot(herb_prod_nutr_part_plot_total) +
  draw_plot(herb_prod_nutr_post_plot_total, x = 0.6, y = .64, width = .35, height = .35)
herb.prod.nutr.plot.with.inset.total

#Save the plot with ggsave()
#ggsave(filename = "../outputs/figures/figure6c_herbivore_productivity_vs_turf_nutrients_total.png", 
#       plot = herb.prod.nutr.plot.with.inset.total,     width = 11,      height = 7.5,      units = "cm",      dpi = 300)


```



####Bayesian analysis based on DAGs - Hypothesis 10a: DIRECT effect of turf nutrients on herbivore biomass----
```{r}
#Need to close biasing paths by including turf productivity and turf cover**
#Need to close biasing paths by including turf productivity and turf cover**

#brms models------
#see previous file for other options/build-up

#log model, uninformative prior: 
herb_bio_turf_nutr_brms<-
  brm(
 log_herb_bio~turf_n15_c + turf_productivity_c + turf_prop_c+ (1|Island), #based on DAG, need to also account for turf nutrients to get both total and direct effect of turf cover on herbivore biomass, productivity
  data = herbivore_turf_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/herb_bio_turf_nutr_brms") #all good
print(herb_bio_turf_nutr_brms) 

pp_check(herb_bio_turf_nutr_brms) #looks good
plot(herb_bio_turf_nutr_brms) #looks good

hypothesis(herb_bio_turf_nutr_brms, "turf_n15_c>0") 
  #hypothesis                est      error     lower     upper       evidence ratio        posterior probability
  #(turf_productivit... > 0	0.04    	0.83	    -1.06	    1.3	          1.09          0.52	
#really no direct effect of turf nutrients on herbivore biomass


#extract some values:------
herb_bio_turf_nutr_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(b_turf_n15_c)
#b_log_seabird      lower       upper     width   point     interval
#0.03178279	        -1.445382	  1.638929	0.95	median	hdi


herb_bio_turf_nutr_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(exp(b_turf_n15_c)) 
#exp(b_N15_in_cs)             lower       upper     width   point     interval
#1.032293	0.0001142619	3.607480	0.95	median	hdi
#1.032293	3.6942111530	3.742277	0.95	median	hdi

herb_bio_turf_nutr_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdci(exp(b_turf_n15_c)) 
#1.032293	0.02741653	3.751378	0.95	median	hdci



##model plots-----
#plot partialized residuals-----
me_herb_bio_nutr<-conditional_effects(herb_bio_turf_nutr_brms, prob = .75, effects = 'turf_n15_c', plot = FALSE)[[1]]

#extract partialized residuals
p_herb_bio_nutr<-partialize(herb_bio_turf_nutr_brms, vars= "turf_n15_c",  data = herbivore_turf_dat_c)


#back-transform growth, centered/scaled n15:----
#get data for un-scaling and centering:
mean(herbivore_turf_dat_c$mean_turf_n15, na.rm=TRUE) #4.653333

me_herb_bio_nutr_unscale<-
  me_herb_bio_nutr%>%
  mutate(mean_turf_n15 = turf_n15_c + 4.653333 ) # + mean


herb_bio_nutr_part_plot<-
p_herb_bio_nutr %>%
  ggplot(aes(x = mean_turf_n15, y = log_herb_bio)) +
     geom_point(color = "#0072B2", fill = "#0072B2",  alpha = 0.4, size = 3) + #, size = .8, width=.07,
    geom_ribbon(data = me_herb_bio_nutr_unscale, aes(ymin =(lower__), ymax=(upper__)), alpha = .2, fill = "#0072B2")+
    geom_line(data = me_herb_bio_nutr_unscale, aes(y = (estimate__)), lwd = 1.2, colour = "#0072B2") +
  ylab(bquote(Herbivore~biomass~(log~kg~ha^-1)))+
xlab(expression(paste("Turf ", delta^15, "N"))) + 
  theme_bw()+
    guides(size = "none", colour = "none",  fill = guide_legend(title="Confidence level")) + 
    theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
    #            text = element_text(size = 24),
        legend.position='none')
herb_bio_nutr_part_plot




#posterior prediction plots------
herb_bio_nutr_post_plot<-
herb_bio_turf_nutr_brms %>%
  spread_draws(b_turf_n15_c) %>%
  ggplot(aes(y = 0, x = b_turf_n15_c, fill = "#0072B2")) + #rescale so .1 mm/day
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 2, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#0072B2"),0.3))+
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
  scale_x_continuous(limits=c(-4, 4), breaks=seq(-4, 4,2))+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
       # text=element_text(size=16,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_bio_nutr_post_plot


##combine and save---------
##make inset plots, then combine and save:
herb.bio.nutr.plot.with.inset <-
  ggdraw() +
  draw_plot(herb_bio_nutr_part_plot) +
  draw_plot(herb_bio_nutr_post_plot, x = 0.1, y = .64, width = .35, height = .35)
herb.bio.nutr.plot.with.inset

#Save the plot with ggsave()
#ggsave(filename = "../outputs/figures/figure6b_herbivore_biomass_vs_turf_nutrients_direct.png", 
 #      plot = herb.bio.nutr.plot.with.inset,     width = 11,      height = 7.5,      units = "cm",      dpi = 300)




```


####Bayesian analysis based on DAGs - Hypothesis 10b: TOTAL effect of turf nutrients on herbivore biomass----
```{r}
#No additional explanatory variables needed*
#No additional explanatory variables needed*

#brms models------
#see previous file for other options/build-up

#log-log model, uninformative prior: 
herb_bio_turf_nutr_total_brms<-
  brm(
 log_herb_bio~turf_n15_c + (1|Island), #based on DAG, need to also account for turf nutrients to get both total and direct effect of turf cover on herbivore biomass, biouctivity
  data = herbivore_turf_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/herb_bio_turf_nutr_total_brms") #all good
print(herb_bio_turf_nutr_total_brms) 

pp_check(herb_bio_turf_nutr_total_brms) #looks good
plot(herb_bio_turf_nutr_total_brms) #looks good

hypothesis(herb_bio_turf_nutr_total_brms, "turf_n15_c>0") 
  #hypothesis                est      error     lower     upper       evidence ratio        posterior probability
  #((turf_n15_c) > 0	      0.43	    0.34    	-0.11	      1	          9.91	                        0.91	
#strong positive total effect of turf nutrients on herbivore biomass


#extract some values:------
herb_bio_turf_nutr_total_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(b_turf_n15_c)
#b_log_seabird      lower       upper     width   point     interval
#0.425021	          -0.2262345	1.129372	0.95	median	hdi

herb_bio_turf_nutr_total_brms %>%
  spread_draws(b_turf_n15_c) %>%
  median_hdi(exp(b_turf_n15_c)) 
#exp(b_N15_in_cs)             lower       upper     
#1.529623                 	0.6621354	    2.790953	

##model plots-----
#plot partialized residuals-----
me_herb_bio_nutr_total<-conditional_effects(herb_bio_turf_nutr_total_brms, prob = .75, effects = 'turf_n15_c', plot = FALSE)[[1]]

#extract partialized residuals
p_herb_bio_nutr_total<-partialize(herb_bio_turf_nutr_total_brms, vars= "turf_n15_c",  data = herbivore_turf_dat_c)


#back-transform growth, centered/scaled n15:----
#get data for un-scaling and centering:
mean(herbivore_turf_dat_c$mean_turf_n15, na.rm=TRUE) #4.653333

me_herb_bio_nutr_total_unscale<-
  me_herb_bio_nutr_total%>%
  mutate(mean_turf_n15 = turf_n15_c + 4.653333 ) # + mean


herb_bio_nutr_part_plot_total<-
p_herb_bio_nutr_total %>%
  ggplot(aes(x = mean_turf_n15, y = log_herb_bio)) +
     geom_point(color = "#0072B2", fill = "#0072B2",  alpha = 0.4, size = 3) + #, size = .8, width=.07,
    geom_ribbon(data = me_herb_bio_nutr_total_unscale, aes(ymin =(lower__), ymax=(upper__)), alpha = .2, fill = "#0072B2")+
    geom_line(data = me_herb_bio_nutr_total_unscale, aes(y = (estimate__)), lwd = 1.2, colour = "#0072B2") +
  ylab(bquote(Herbivore~biomass~(log~kg~ha^-1)))+
xlab(expression(paste("Turf ", delta^15, "N"))) + 
  theme_bw()+
    guides(size = "none", colour = "none",  fill = guide_legend(title="Confidence level")) + 
    theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
    #            text = element_text(size = 24),
        legend.position='none')
herb_bio_nutr_part_plot_total




#posterior prediction plots------
herb_bio_nutr_post_plot_total<-
herb_bio_turf_nutr_total_brms %>%
  spread_draws(b_turf_n15_c) %>%
  ggplot(aes(y = 0, x = b_turf_n15_c, fill = "#0072B2")) + #rescale so .1 mm/day
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 2, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#0072B2"),0.3))+
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
 # scale_x_continuous(limits=c(-2.5, 3), breaks=seq(-2, 3,1))+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
       # text=element_text(size=16,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_bio_nutr_post_plot_total


##combine and save---------
##make inset plots, then combine and save:
herb.bio.nutr.plot.with.inset.total <-
  ggdraw() +
  draw_plot(herb_bio_nutr_part_plot_total) +
  draw_plot(herb_bio_nutr_post_plot_total, x = 0.1, y = .64, width = .35, height = .35)
herb.bio.nutr.plot.with.inset.total

#Save the plot with ggsave()
#ggsave(filename = "../outputs/figures/figure6d_herbivore_biomass_vs_turf_nutrients_total.png", 
 #      plot = herb.bio.nutr.plot.with.inset.total,     width = 11,      height = 7.5,      units = "cm",      dpi = 300)


```

##combine and save all 4 panels of figure 6:
```{r}
#total:
herb.bio.nutr.plot.with.inset.total
herb.prod.nutr.plot.with.inset.total
#direct:
herb.bio.nutr.plot.with.inset
herb.prod.nutr.plot.with.inset

fig6<-plot_grid(herb.prod.nutr.plot.with.inset, herb.bio.nutr.plot.with.inset, herb.prod.nutr.plot.with.inset.total, herb.bio.nutr.plot.with.inset.total) #, labels = c("(a) Turf productivity", "(b) Turf cover"),
               #label_size = 12, label_fontface = "plain", # hjust = -1,   vjust = 1,
              #  scale = .95)
fig6


#ggsave(filename = "../outputs/figures/figure6_combined.png", 
#       plot = fig6,
#       width = 25, 
#       height = 22,
#       units = "cm",
#       dpi = 300)

##actually, works better with patchwork to allow white space between rows:----
library(patchwork)
fig6<-herb.prod.nutr.plot.with.inset   + herb.bio.nutr.plot.with.inset + plot_spacer() +   plot_spacer() + herb.prod.nutr.plot.with.inset.total  + herb.bio.nutr.plot.with.inset.total + plot_layout(ncol = 2) + 
   plot_layout(heights = c(1, .05, 1)) & theme(plot.background = element_rect(fill = "white",color = "white"), rect = element_rect(fill = "white",color = "white")) #png saving adds weird borders to plots, but re-setting overall theme to white here solves it
fig6

ggsave(filename = "../outputs/figures/figure6_combined.png", 
       plot = fig6,
       width = 25, 
       height = 22,
       units = "cm",
       dpi = 300)



ggsave(filename = "../outputs/figures/figure6_combined.pdf", 
       plot = fig6,
       width = 25, 
       height = 22,
       units = "cm",
       dpi = 300)




```



####Bayesian analysis based on REVERSED DAG: effect of turf productivity on herbivore productivity----
```{r}
#now no additional explanatory variables need to close biasing paths for both total and direct effects

#brms models------
#see previous file for other options/build-up

#log model, uninformative prior: 
herb_prod_turf_prod_brms_reverse<-
  brm(
 log_herb_prod~turf_productivity_c +(1|Island), #based on reverse DAG, no biasing paths.
  data = herbivore_turf_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/herb_prod_turf_prod_brms_reverse") 
print(herb_prod_turf_prod_brms_reverse) #worked

pp_check(herb_prod_turf_prod_brms_reverse) #looks good
plot(herb_prod_turf_prod_brms_reverse) #looks good

hypothesis(herb_prod_turf_prod_brms_reverse, "turf_productivity_c>0") 
  #hypothesis                est      error     lower     upper       evidence ratio        posterior probability
  #(turf_productivit... > 0 	2.98	  3.38	  -2.22	        8.12      	6.6	                        0.87
#positive effect of turf productivity on herbivore productivity


#extract some values:------
herb_prod_turf_prod_brms_reverse %>%
  spread_draws(b_turf_productivity_c) %>%
  median_hdi(b_turf_productivity_c)
#b_log_seabird      lower       upper     width   point     interval
# 2.966165      	-3.825244   	9.949281				0.95	median	hdi


herb_prod_turf_prod_brms_reverse %>%
  spread_draws(b_turf_productivity_c) %>%
  median_hdi(exp(b_turf_productivity_c/10)) #estimates look crazy! because 1 mm/day increase in turf is super high...
#divide to make it .1 mm/day increase:
#exp(b_N15_in_cs)             lower       upper     width   point     interval
#1.345299                   	0.5184444	  2.393028					0.95	median	hdi



#posterior plots------
herb_prod_pp_post_plot_reverse<-
herb_prod_turf_prod_brms_reverse %>%
  spread_draws(b_turf_productivity_c) %>%
  ggplot(aes(y = 0, x = b_turf_productivity_c/10, fill = after_stat(x < 0))) + #rescale so .1 mm/day
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 1, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#d0e2af" ,"#e89c81"),1)) +#PNW color palette
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
 # ggtitle("effect of turf productivity on herbivore productivity")+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
        text=element_text(size=10,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_prod_pp_post_plot_reverse


#Save the plot with ggsave()
#ggsave(filename = "../outputs/figures/supp_fig_herb_prod_pp_post_plot_reverse.pdf", plot = herb_prod_pp_post_plot_reverse,  width = 8,   height = 5,  units = "cm", dpi = 300)

```

####Bayesian analysis based on REVERSED DAG: effect of turf productivity on herbivore biomass----
```{r}
#now no additional explanatory variables need to close biasing paths for both total and direct effects

#brms models------
#see previous file for other options/build-up

#log model, uninformative prior: 
herb_bio_turf_prod_brms_reverse<-
  brm(
 log_herb_bio~turf_productivity_c +(1|Island),  #based on reverse DAG, no biasing paths.
  data = herbivore_turf_dat_c, 
  iter = 3000, warmup = 1000, chains = 4, cores = 4,
   control = list(adapt_delta = 0.999, max_treedepth = 15), 
      file = "../outputs/brms/herb_bio_turf_prod_brms_reverse") 
print(herb_bio_turf_prod_brms_reverse) #worked

pp_check(herb_bio_turf_prod_brms_reverse) #looks good
plot(herb_bio_turf_prod_brms_reverse) #looks good

hypothesis(herb_bio_turf_prod_brms_reverse, "turf_productivity_c>0") 
  #hypothesis                est      error     lower     upper       evidence ratio        posterior probability
  #(turf_productivit... > 0 	7.94	  5.69	    -0.55     	17.83         	15.19               	0.94	
#positive effect of turf productivity on herbivore biomass


#extract some values:------
herb_bio_turf_prod_brms_reverse %>%
  spread_draws(b_turf_productivity_c) %>%
  median_hdi(b_turf_productivity_c)
#b_log_seabird      lower       upper     width   point     interval
# 7.553179        	-3.01506	20.17194				0.95	median	hdi


herb_bio_turf_prod_brms_reverse %>%
  spread_draws(b_turf_productivity_c) %>%
  median_hdi(exp(b_turf_productivity_c/10)) #estimates look crazy! because 1 mm/day increase in turf is super high...
#divide to make it .1 mm/day increase:
#est                          lower       upper     width   point     interval
#2.128288	                0.2832003   	5.971636						0.95	median	hdi



#posterior prediction plots------
herb_bio_pp_post_plot_reverse<-
herb_bio_turf_prod_brms_reverse %>%
  spread_draws(b_turf_productivity_c) %>%
  ggplot(aes(y = 0, x = b_turf_productivity_c/10, fill = after_stat(x < 0))) + #rescale so .1 mm/day
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 1, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#d0e2af" ,"#e89c81"),1)) +#PNW color palette
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
 # ggtitle("effect of turf productivity on herbivore biomass")+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
        text=element_text(size=10,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_bio_pp_post_plot_reverse


#Save the plot with ggsave()
#ggsave(filename = "../outputs/figures/supp_fig_herb_bio_pp_post_plot_reverse.pdf", plot = herb_bio_pp_post_plot_reverse,  width = 8,   height = 5,  units = "cm", dpi = 300)

```


####Bayesian analysis based on REVERSED DAG: effect of herbivore productivity on turf cover----
```{r}
#for both total and direct effects of herbivore productivity, biomass on turf cover: control for turf growth
#looks like may be log-log relaionthip - use that. 

herbivore_turf_dat_c2<-
  herbivore_turf_dat_c%>%
  mutate(herb_bio_c = base::scale(herb_biomass_kg_ha, center= TRUE, scale = FALSE),
         herb_prod_c = base::scale(herb_productivity_kg_ha_day, center= TRUE, scale = FALSE),
         herb_log_bio_c = base::scale(log_herb_bio, center= TRUE, scale = FALSE),
         herb_log_prod_c = base::scale(log_herb_prod, center= TRUE, scale = FALSE),
          log_turf_cover = log(turf_prop))


#herb prod----
log_turf_cover_herb_prod_brms_reverse<-
  brm(log_turf_cover ~   herb_log_prod_c   + turf_productivity_c+(1|Island),
       data = herbivore_turf_dat_c2,
        iter = 3000, warmup = 1000, chains = 4, cores = 4,
         control = list(adapt_delta = 0.999, max_treedepth = 15), 
       file = "../outputs/brms/log_turf_cover_herb_prod_brms_reverse") #worked

print(log_turf_cover_herb_prod_brms_reverse)
pp_check(log_turf_cover_herb_prod_brms_reverse) #
plot(log_turf_cover_herb_prod_brms_reverse)

hypothesis(log_turf_cover_herb_prod_brms_reverse, "herb_log_prod_c<0") 
#hypothesis             est       se        lower       upper      evid ratio   posterior prob 
#                         -0.4	  0.42	    -1.08	        0.29        	5.15      	0.84	

#herb bio----
log_turf_cover_herb_bio_brms_reverse<-
  brm(log_turf_cover ~   herb_log_bio_c   + turf_productivity_c+(1|Island),
       data = herbivore_turf_dat_c2,
        iter = 3000, warmup = 1000, chains = 4, cores = 4,
         control = list(adapt_delta = 0.999, max_treedepth = 15), 
       file = "../outputs/brms/log_turf_cover_herb_bio_brms_reverse") #2 divergent trans

print(log_turf_cover_herb_bio_brms_reverse)
pp_check(log_turf_cover_herb_bio_brms_reverse) #
plot(log_turf_cover_herb_bio_brms_reverse)

hypothesis(log_turf_cover_herb_bio_brms_reverse, "herb_log_bio_c<0") 
#hypothesis             est       se        lower       upper      evid ratio   posterior prob 
#                     -0.24	        0.37  	-0.87	        0.34         	2.97	      0.75	


```

#plots for REVERSED dag - herbivore prod and bio effect on turf cover
```{r}

##herbivore prod plots-----
#plot partialized residuals-----
me_turf_cover_herb_prod_reverse<-conditional_effects(log_turf_cover_herb_prod_brms_reverse, prob = .75, effects = 'herb_log_prod_c', plot = FALSE)[[1]]

#extract partialized residuals
p_herb_prod_cover_reverse<-partialize(log_turf_cover_herb_prod_brms_reverse, vars= "herb_log_prod_c",  data = herbivore_turf_dat_c2)


#back-transform growth, centered/scaled n15:----
#get data for un-scaling and centering:
mean(herbivore_turf_dat_c2$log_herb_prod, na.rm=TRUE) #-1.086916

me_turf_cover_herb_prod_reverse_unscale<-
  me_turf_cover_herb_prod_reverse%>%
  mutate(log_herb_prod = herb_log_prod_c + -1.086916 ) # + mean


herb_prod_cover_part_plot_reverse<-
p_herb_prod_cover_reverse %>%
  ggplot(aes(x = log_herb_prod, y = log_turf_cover)) +
     geom_point(color = "#EE7733", fill = "#EE7733",  alpha = 0.4, size = 3) + #, size = .8, width=.07,
    geom_ribbon(data = me_turf_cover_herb_prod_reverse_unscale, aes(ymin =(lower__), ymax=(upper__)), alpha = .2, fill = "#EE7733")+
    geom_line(data = me_turf_cover_herb_prod_reverse_unscale, aes(y = (estimate__)), lwd = 1.2, colour = "#EE7733") +
  xlab(bquote(Herbivore~productivity~(log~kg~ha^-1~day^-1)))+
ylab("Turf (proportional cover)")+
  theme_bw()+
    guides(size = "none", colour = "none",  fill = guide_legend(title="Confidence level")) + 
    theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(),
    #            text = element_text(size = 24),
        legend.position='none')
herb_prod_cover_part_plot_reverse




#posterior prediction plots------
herb_prod_cover_post_plot_reverse<-
log_turf_cover_herb_prod_brms_reverse %>%
  spread_draws(b_herb_log_prod_c) %>%
  ggplot(aes(y = 0, x = b_herb_log_prod_c, fill = after_stat(x < 0))) +
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 1, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#d0e2af" ,"#e89c81"),1)) +#PNW color palette
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
 # ggtitle("effect of herbivore productivity on turf cover")+
 # scale_x_continuous( breaks=c(0,1,2), labels =c("0.0", "1.0", "2.0"))+
 # scale_x_continuous(breaks=seq(-.5, .5,.5))+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
        text=element_text(size=10,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_prod_cover_post_plot_reverse

#Save the plot with ggsave()
#ggsave(filename = "../outputs/figures/supp_fig_herb_prod_cover_post_plot_reverse.pdf", plot = herb_prod_cover_post_plot_reverse,  width = 8,   height = 5,  units = "cm", dpi = 300)


###turf cover - herb biomass plot
herb_bio_cover_post_plot_reverse<-
log_turf_cover_herb_bio_brms_reverse %>%
  spread_draws(b_herb_log_bio_c) %>%
  ggplot(aes(y = 0, x = b_herb_log_bio_c, fill = after_stat(x < 0))) +
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 1, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#d0e2af" ,"#e89c81"),1)) +#PNW color palette
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
#  ggtitle("effect of herbivore biomass on turf cover")+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
        text=element_text(size=10,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
herb_bio_cover_post_plot_reverse


#Save the plot with ggsave()
#ggsave(filename = "../outputs/figures/supp_fig_herb_bio_cover_post_plot_reverse.pdf", plot = herb_bio_cover_post_plot_reverse,  width = 8,   height = 5,  units = "cm", dpi = 300)

```


#check for total effect of turf growth on turf cover
```{r}

#based on DAG assuming direct link between turf growth and turf cover. 

#turf growth-turf cover - total effect
log_turf_cover_turf_growth_brms_reverse_total<-
  brm(log_turf_cover ~   turf_productivity_c+(1|Island),
       data = herbivore_turf_dat_c2,
        iter = 3000, warmup = 1000, chains = 4, cores = 4,
         control = list(adapt_delta = 0.999, max_treedepth = 15), 
       file = "../outputs/brms/log_turf_cover_turf_growth_brms_reverse_total") #0 divergent trans

print(log_turf_cover_turf_growth_brms_reverse_total)
pp_check(log_turf_cover_turf_growth_brms_reverse_total) #
plot(log_turf_cover_turf_growth_brms_reverse_total)


hypothesis(log_turf_cover_turf_growth_brms_reverse_total, c("turf_productivity_c<0")) #0.87
#okay so pretty strong negative total effect of turf growth on turf cover, interesting. 



###turf cover - turf prod plot-----
log_turf_cover_turf_growth_brms_reverse_plot<-
log_turf_cover_turf_growth_brms_reverse_total %>%
  spread_draws(b_turf_productivity_c) %>%
  ggplot(aes(y = 0, x = b_turf_productivity_c/10, fill = after_stat(x < 0))) +
  stat_halfeye(point_interval=median_hdi, .width=c(.95, .75), fatten_point = 1, slab_alpha = 0.6) +
  scale_fill_manual(values = alpha(c("#d0e2af" ,"#e89c81"),1)) +#PNW color palette
  geom_vline(xintercept = 0, linetype = "dashed") +
  theme_bw() + 
  xlab("")+
  ylab("")+
#  ggtitle("effect of turf productivity on turf cover")+
  theme(panel.grid.major = element_blank(), # remove gridlines
        panel.grid.minor = element_blank(), #remove gridlines
        strip.background = element_blank(), 
        legend.position = "none",  
        rect = element_rect(fill = "transparent"),  
        plot.background = element_rect(fill = "transparent", color = NA),
        text=element_text(size=10,  family="sans"),
          axis.text.y = element_blank(),
        axis.ticks.y = element_blank())
log_turf_cover_turf_growth_brms_reverse_plot


#Save the plot with ggsave()
#ggsave(filename = "../outputs/figures/supp_fig_turf_cover_turf_growth_brms_reverse_plot.pdf", plot = log_turf_cover_turf_growth_brms_reverse_plot,  width = 8,   height = 5,  units = "cm", dpi = 300)
```

